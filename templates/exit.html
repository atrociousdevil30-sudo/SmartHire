{% extends "base.html" %}

{% block title %}Employee Offboarding{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header and Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h1 class="h3 mb-1 text-light">
                                <i class="fas fa-door-open me-2"></i>Employee Offboarding
                            </h1>
                            <p class="text-muted mb-0">Track and manage the employee exit process</p>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-column align-items-md-end mt-3 mt-md-0">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-3">Completion:</span>
                                    <div class="progress bg-dark bg-opacity-50" style="height: 10px; width: 200px;">
                                        <div id="exitProgressBar" class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 0%" 
                                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <span class="ms-2 fw-bold" id="progressPercentage">0%</span>
                                </div>
                                <div class="d-flex gap-2">
                                    {% if session.get('role') in ['hr', 'admin', 'manager'] %}
                                    <button class="btn btn-sm btn-outline-light" id="downloadSummary">
                                        <i class="fas fa-download me-1"></i> Export Report
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" id="completeExit" disabled>
                                        <i class="fas fa-check-circle me-1"></i> Complete Exit
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <div class="card mt-3">
                <div class="card-header bg-dark bg-opacity-25">
                    <h2 class="h5 mb-0"><i class="bi bi-graph-up me-2"></i>Exit Analytics</h2>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6 col-lg-4">
                            <div class="card bg-dark bg-opacity-10 border-secondary">
                                <div class="card-body text-center">
                                    <h3 class="mb-1 text-primary">24</h3>
                                    <p class="text-muted small mb-0">Exit Interviews</p>
                                    <div class="text-success small">
                                        <i class="bi bi-arrow-up"></i> 12% from last quarter
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <div class="card bg-dark bg-opacity-10 border-secondary">
                                <div class="card-body text-center">
                                    <h3 class="mb-1 text-success">68%</h3>
                                    <p class="text-muted small mb-0">Would Rehire</p>
                                    <div class="text-danger small">
                                        <i class="bi bi-arrow-down"></i> 5% from last quarter
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <div class="card bg-dark bg-opacity-10 border-secondary">
                                <div class="card-body text-center">
                                    <h3 class="mb-1 text-warning">3.8</h3>
                                    <p class="text-muted small mb-0">Avg. Satisfaction</p>
                                    <div class="text-success small">
                                        <i class="bi bi-arrow-up"></i> 0.2 from last quarter
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-uppercase text-muted mb-0">Reasons for Leaving</h6>
                            <span class="badge bg-primary">Top 6 Reasons</span>
                        </div>
                        <div class="card bg-dark bg-opacity-10 border-0">
                            <div class="card-body p-3">
                                <div class="row g-2">
                                    <div class="col-6 col-md-4">
                                        <div class="d-flex align-items-center p-2 rounded hover-bg">
                                            <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-2">
                                                <i class="bi bi-briefcase text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="small fw-medium">Career Growth</div>
                                                <div class="extra-small text-muted">Limited advancement</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="d-flex align-items-center p-2 rounded hover-bg">
                                            <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-2">
                                                <i class="bi bi-cash-coin text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="small fw-medium">Compensation</div>
                                                <div class="extra-small text-muted">Pay & benefits</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="d-flex align-items-center p-2 rounded hover-bg">
                                            <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-2">
                                                <i class="bi bi-people text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="small fw-medium">Management</div>
                                                <div class="extra-small text-muted">Leadership issues</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="d-flex align-items-center p-2 rounded hover-bg">
                                            <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-2">
                                                <i class="bi bi-heart-pulse text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="small fw-medium">Work-Life</div>
                                                <div class="extra-small text-muted">Balance issues</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="d-flex align-items-center p-2 rounded hover-bg">
                                            <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-2">
                                                <i class="bi bi-lightbulb text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="small fw-medium">Recognition</div>
                                                <div class="extra-small text-muted">Lack of appreciation</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="d-flex align-items-center p-2 rounded hover-bg">
                                            <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-2">
                                                <i class="bi bi-building text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="small fw-medium">Culture</div>
                                                <div class="extra-small text-muted">Work environment</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Employee Details -->
            <div class="card bg-dark bg-opacity-25 border-secondary mb-4">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-user-tie me-2"></i>Employee Details
                    </h5>
                </div>
                <div class="card-body">
                    {% if employee and employee.exit_date %}
                    <div class="text-center mb-4">
                        <div class="avatar-xxl mb-3">
                            <div class="avatar-title bg-primary bg-opacity-10 text-primary rounded-circle display-4">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                        <h4 class="mb-1 text-light">{{ employee.full_name }}</h4>
                        <p class="text-muted">{{ employee.role }}</p>
                        <div class="d-flex justify-content-center gap-2 mb-3 flex-wrap">
                            <span class="badge bg-primary">Employee ID: {{ employee.employee_id or 'EMP-' + employee.id|string }}</span>
                            <span class="badge bg-secondary">Department: {{ employee.department or 'General' }}</span>
                        </div>
                    </div>
                    
                    <div class="border-top border-secondary pt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Email:</span>
                            <a href="mailto:{{ employee.email }}" class="text-light">{{ employee.email }}</a>
                        </div>
                        {% if employee.phone %}
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Phone:</span>
                            <a href="tel:{{ employee.phone }}" class="text-light">{{ employee.phone }}</a>
                        </div>
                        {% endif %}
                        {% if employee.hire_date %}
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Hire Date:</span>
                            <span class="text-light">{{ employee.hire_date.strftime('%B %d, %Y') }}</span>
                        </div>
                        {% endif %}
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Exit Date:</span>
                            <span class="text-light">{{ employee.exit_date.strftime('%B %d, %Y') if employee.exit_date else 'Not set' }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Notice Period:</span>
                            <span class="text-light">30 days</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Exit Type:</span>
                            <span class="text-light">Resignation</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Status:</span>
                            <span class="badge bg-warning">Offboarding</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-user-check fa-3x text-muted" style="opacity: 0.5;"></i>
                        </div>
                        <h5 class="text-light mb-2">No Employee Exiting</h5>
                        <p class="text-muted mb-0">No employee is currently exiting the organization.</p>
                        <p class="text-muted small mt-2">Once an employee initiates their exit process, their details will appear here.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Actions -->
            {% if employee and employee.exit_date %}
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-light text-start" type="button" data-bs-toggle="modal" data-bs-target="#sendReminderModal">
                            <i class="far fa-bell me-2"></i> Send Reminder
                        </button>
                        <button class="btn btn-outline-light text-start" type="button" data-bs-toggle="modal" data-bs-target="#extendNoticeModal">
                            <i class="far fa-calendar-plus me-2"></i> Extend Notice Period
                        </button>
                        <button class="btn btn-outline-light text-start" type="button" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                            <i class="far fa-sticky-note me-2"></i> Add Private Note
                        </button>
                        <button class="btn btn-outline-danger text-start" type="button" id="terminateImmediately">
                            <i class="fas fa-user-slash me-2"></i> Terminate Immediately
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- HR Contact Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-user-tie me-2"></i>Your HR Contact
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="avatar-xl me-3">
                            <div class="avatar-title bg-primary bg-opacity-10 text-primary rounded-circle">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 text-light">{{ hr_contact.full_name if hr_contact else 'HR Department' }}</h6>
                            <p class="text-muted mb-1">{{ hr_contact.position if hr_contact and hr_contact.position else 'HR Business Partner' }}</p>
                            <p class="text-muted mb-0">
                                <a href="mailto:{{ hr_contact.email if hr_contact else 'hr@company.com' }}" class="text-light">
                                    {{ hr_contact.email if hr_contact else 'hr@company.com' }}
                                </a>
                            </p>
                        </div>
                        <div class="ms-auto">
                            <button class="btn btn-outline-light btn-sm" onclick="messageHR()">
                                <i class="fab fa-whatsapp me-1"></i> WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exit Checklist Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-clipboard-check me-2"></i>Exit Checklist
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-light mb-3">HR Tasks</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="hr1">
                                <label class="form-check-label text-light" for="hr1">
                                    Conduct exit interview
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="hr2">
                                <label class="form-check-label text-light" for="hr2">
                                    Process final paycheck
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="hr3">
                                <label class="form-check-label text-light" for="hr3">
                                    Prepare experience letter
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-light mb-3">IT Tasks</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="it1">
                                <label class="form-check-label text-light" for="it1">
                                    Revoke system access
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="it2">
                                <label class="form-check-label text-light" for="it2">
                                    Collect company assets
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="it3">
                                <label class="form-check-label text-light" for="it3">
                                    Disable email account
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Progress: <span id="checklistProgress">0</span>/6 completed</span>
                                <button class="btn btn-primary btn-sm" onclick="saveChecklist()">Save Progress</button>
                            </div>
                            <div class="progress mt-2" style="height: 10px;">
                                <div class="progress-bar bg-primary" id="checklistProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Submissions Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark bg-opacity-25">
                    <h2 class="h5 mb-0"><i class="bi bi-table me-2"></i>Recent Submissions</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Exit Date</th>
                                    <th>Reason</th>
                                    <th>Satisfaction</th>
                                    <th>Rehire</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for feedback in exit_feedbacks %}
                                <tr>
                                    <td>{{ feedback.name }}</td>
                                    <td>{{ employee.department or 'General' }}</td>
                                    <td>{{ feedback.created_at.strftime('%b %d, %Y') }}</td>
                                    <td>{{ feedback.reason[:50] + '...' if feedback.reason|length > 50 else feedback.reason }}</td>
                                    <td><span class="badge bg-success">{{ feedback.sentiment or 'Neutral' }}</span></td>
                                    <td><span class="badge bg-success">Yes</span></td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary view-exit-btn" data-exit-id="{{ feedback.id }}">View</button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">No exit interviews found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted small">Showing 1 to 3 of 24 entries</div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#">Next</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

<!-- ... existing code ... -->

{% block extra_js %}
<script>
// ... existing code ...

// Initialize offboarding tasks
const tasks = [
    { id: 1, title: 'Laptop/Asset Return', status: 'pending', risk: 'high', dueDate: '2023-11-19', completed: false, assignedTo: 'it' },
    { id: 2, title: 'ID Card Return', status: 'pending', risk: 'medium', dueDate: '2023-11-18', completed: false, assignedTo: 'hr' },
    { id: 3, title: 'Email Revocation', status: 'pending', risk: 'high', dueDate: '2023-11-17', completed: false, assignedTo: 'it' },
    { id: 4, title: 'System Access Revocation', status: 'in-progress', risk: 'high', dueDate: '2023-11-18', completed: false, assignedTo: 'it' },
    { id: 5, title: 'Exit Interview', status: 'pending', risk: 'low', dueDate: '2023-11-19', completed: false, assignedTo: 'hr' },
    { id: 6, title: 'Clearance Check', status: 'pending', risk: 'medium', dueDate: '2023-11-20', completed: false, assignedTo: 'finance' },
    { id: 7, title: 'Experience Letter', status: 'completed', risk: 'low', dueDate: '2023-11-15', completed: true, assignedTo: 'hr' }
];

// Render tasks
const taskList = document.getElementById('offboardingTasks');
tasks.forEach(task => {
    const taskRow = document.createElement('tr');
    taskRow.innerHTML = `
        <td>${task.title}</td>
        <td>
            <span class="badge bg-${task.status === 'pending' ? 'warning' : task.status === 'in-progress' ? 'primary' : 'success'} bg-opacity-25 text-${task.status === 'pending' ? 'warning' : task.status === 'in-progress' ? 'primary' : 'success'}">
                ${task.status === 'pending' ? '<i class="fas fa-clock me-1"></i> Pending' : task.status === 'in-progress' ? '<i class="fas fa-spinner me-1"></i> In Progress' : '<i class="fas fa-check-circle me-1"></i> Completed'}
            </span>
        </td>
        <td>
            <span class="badge bg-${task.risk === 'high' ? 'danger' : task.risk === 'medium' ? 'warning' : 'success'} bg-opacity-25 text-${task.risk === 'high' ? 'danger' : task.risk === 'medium' ? 'warning' : 'success'}">
                ${task.risk === 'high' ? '<i class="fas fa-exclamation-triangle me-1"></i> High' : task.risk === 'medium' ? '<i class="fas fa-exclamation-circle me-1"></i> Medium' : '<i class="fas fa-check-circle me-1"></i> Low'}
            </span>
        </td>
        <td>${task.dueDate}</td>
        <td>${task.assignedTo}</td>
        <td class="text-end">
            <button class="btn btn-sm btn-outline-primary view-task-btn" data-task-id="${task.id}">View</button>
        </td>
    `;
    taskList.appendChild(taskRow);
});

// Checklist functionality
function updateChecklistProgress() {
    const checkboxes = document.querySelectorAll('#checklistProgress').closest('.card-body').querySelectorAll('input[type="checkbox"]');
    const checked = document.querySelectorAll('#checklistProgress').closest('.card-body').querySelectorAll('input[type="checkbox"]:checked');
    const progress = checked.length;
    const total = checkboxes.length;
    const percentage = (progress / total) * 100;
    
    document.getElementById('checklistProgress').textContent = progress;
    document.getElementById('checklistProgressBar').style.width = percentage + '%';
}

// Add event listeners to checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.form-check-input');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateChecklistProgress);
    });
});

function saveChecklist() {
    // Here you can add functionality to save the checklist state
    alert('Checklist progress saved!');
}

function messageHR() {
    // Get HR phone number from the template
    const hrPhone = '{{ hr_contact.phone if hr_contact else "" }}';
    
    if (!hrPhone) {
        alert('HR contact phone number is not available');
        return;
    }
    
    // Format phone number (remove any spaces, dashes, parentheses)
    const cleanPhone = hrPhone.replace(/[\s\-()]/g, '');
    
    // Ensure phone number starts with country code (add +91 for India if not present)
    let formattedPhone = cleanPhone;
    if (!cleanPhone.startsWith('+')) {
        if (cleanPhone.length === 10) {
            formattedPhone = '+91' + cleanPhone; // India country code
        } else if (!cleanPhone.startsWith('91')) {
            formattedPhone = '+91' + cleanPhone;
        } else {
            formattedPhone = '+' + cleanPhone;
        }
    }
    
    // Create WhatsApp message
    const message = encodeURIComponent('Hi,\n\nI have a question regarding my exit process.\n\nThank you.');
    
    // Open WhatsApp chat
    window.open(`https://wa.me/${formattedPhone}?text=${message}`, '_blank');
}

// ... existing code ...
</script>
    opacity: 0.7;
}
</style>
{% endblock %}
