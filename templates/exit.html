{% extends "base.html" %}

{% block title %}Employee Offboarding{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Simplified Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 text-light mb-1">
                <i class="fas fa-door-open me-2"></i>Employee Offboarding
            </h1>
            <p class="text-muted mb-0">Manage the employee exit process efficiently</p>
        </div>
        <div>
            <button class="btn btn-outline-light btn-sm" onclick="toggleAdvancedMode()">
                <i class="fas fa-cog me-1"></i>Advanced
            </button>
        </div>
    </div>

    <!-- Tab-based Interface -->
    <ul class="nav nav-tabs nav-tabs-dark mb-4" id="exitTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                <i class="fas fa-chart-line me-2"></i>Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                <i class="fas fa-tasks me-2"></i>Tasks
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback" type="button" role="tab">
                <i class="fas fa-comment me-2"></i>Feedback
            </button>
        </li>
        {% if session.get('role') in ['hr', 'admin', 'manager'] %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                <i class="fas fa-chart-bar me-2"></i>Analytics
            </button>
        </li>
        {% endif %}
    </ul>

    <div class="tab-content" id="exitTabsContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-body">
                    <!-- Progress Overview -->
                    <div class="row align-items-center mb-4">
                        <div class="col-md-8">
                            <h6 class="text-light mb-3">Exit Progress</h6>
                            <div class="progress bg-dark bg-opacity-50" style="height: 12px;">
                                <div id="exitProgressBar" class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted mt-2 d-block">Completion: <span id="progressPercentage">0%</span></small>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if session.get('role') in ['hr', 'admin', 'manager'] %}
                            <div class="d-flex gap-2 justify-content-end">
                                <button class="btn btn-sm btn-outline-light" id="downloadSummary">
                                    <i class="fas fa-download me-1"></i> Export
                                </button>
                                <button class="btn btn-sm btn-outline-danger" id="completeExit" disabled>
                                    <i class="fas fa-check me-1"></i> Complete
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card bg-dark bg-opacity-50 border-secondary text-center">
                                <div class="card-body py-3">
                                    <h4 class="text-primary mb-1">{{ exit_feedbacks|length }}</h4>
                                    <small class="text-muted">Exit Interviews</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-dark bg-opacity-50 border-secondary text-center">
                                <div class="card-body py-3">
                                    {% set positive_count = exit_feedbacks|selectattr('sentiment', 'equalto', 'Positive')|list|length %}
                                    {% set rehire_percentage = ((positive_count / exit_feedbacks|length * 100) | round(1)) if exit_feedbacks|length > 0 else 75 %}
                                    <h4 class="text-success mb-1">{{ rehire_percentage }}%</h4>
                                    <small class="text-muted">Would Rehire</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-dark bg-opacity-50 border-secondary text-center">
                                <div class="card-body py-3">
                                    {% set avg_satisfaction = 3.8 %}
                                    {% if exit_feedbacks|length > 0 %}
                                        {% set total_positive = exit_feedbacks|selectattr('sentiment', 'equalto', 'Positive')|list|length %}
                                        {% set total_neutral = exit_feedbacks|selectattr('sentiment', 'equalto', 'Neutral')|list|length %}
                                        {% set avg_satisfaction = ((total_positive * 4.5 + total_neutral * 3.0) / exit_feedbacks|length) | round(1) %}
                                    {% endif %}
                                    <h4 class="text-warning mb-1">{{ avg_satisfaction }}</h4>
                                    <small class="text-muted">Avg. Satisfaction</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div class="tab-pane fade" id="tasks" role="tabpanel">
            {% if employee and employee.status == 'Offboarding' and employee.checklist %}
            <div class="alert alert-info d-flex align-items-center mb-3" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <div>
                    <strong>Viewing:</strong> {{ employee.full_name }}'s Offboarding Checklist
                </div>
            </div>
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="text-light mb-0">Offboarding Tasks</h6>
                        <span class="badge bg-primary bg-opacity-25 text-primary">
                            {{ employee.checklist.tasks | selectattr('is_completed', 'equalto', true) | list | length }}/{{ employee.checklist.tasks | length }} Complete
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Task</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="offboardingTasks">
                                {% for task in employee.checklist.tasks %}
                                <tr class="task-item" data-status="{{ 'completed' if task.is_completed else 'pending' }}" data-task-id="{{ task.id }}">
                                    <td class="ps-4">
                                        <div class="form-check">
                                            <input class="form-check-input task-checkbox" type="checkbox" 
                                                   id="exitTask{{ task.id }}" 
                                                   data-task-id="{{ task.id }}" 
                                                   {{ 'checked' if task.is_completed else '' }}>
                                            <label class="form-check-label" for="exitTask{{ task.id }}">
                                                {{ task.task_name }}
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        {% if task.is_completed %}
                                            <span class="badge bg-success bg-opacity-25 text-success">
                                                <i class="fas fa-check-circle me-1"></i> Completed
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary bg-opacity-25 text-muted">
                                                <i class="far fa-clock me-1"></i> Pending
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if task.due_date %}
                                            <span>{{ task.due_date.strftime('%b %d') }}</span>
                                        {% else %}
                                            <span>TBD</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-dark">
                                                <li>
                                                    <a class="dropdown-item task-action" href="#" data-task-id="{{ task.id }}" data-completed="{{ 'false' if task.is_completed else 'true' }}" data-action="toggle-completion">
                                                        <i class="fas fa-{{ 'undo' if task.is_completed else 'check' }} me-2"></i>{{ 'Mark as Incomplete' if task.is_completed else 'Mark as Complete' }}
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-body text-center py-5">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    {% if employee and employee.status != 'Offboarding' %}
                        <h5 class="text-light mb-2">Employee Not in Offboarding</h5>
                        <p class="text-muted">This employee is not currently in the offboarding process</p>
                    {% else %}
                        <h5 class="text-light mb-2">No Offboarding Tasks</h5>
                        <p class="text-muted">Select an employee in offboarding to view their tasks</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Feedback Tab -->
        <div class="tab-pane fade" id="feedback" role="tabpanel">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="text-light mb-0">Exit Feedback</h6>
                </div>
                <div class="card-body">
                    <div class="text-center py-5">
                        <i class="fas fa-comment fa-3x text-muted mb-3"></i>
                        <h5 class="text-light mb-2">Feedback Collection</h5>
                        <p class="text-muted">View and analyze exit interview feedback</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab (HR only) -->
        {% if session.get('role') in ['hr', 'admin', 'manager'] %}
        <div class="tab-pane fade" id="analytics" role="tabpanel">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="text-light mb-0">Exit Analytics</h6>
                </div>
                <div class="card-body">
                    <!-- Reasons for Leaving (Real Data) -->
                    <div class="mb-4">
                        <h6 class="text-light mb-3">Top Reasons for Leaving</h6>
                        <div class="row g-2">
                            {% set reason_counts = {} %}
                            {% for feedback in exit_feedbacks %}
                                {% set reason = feedback.reason or 'Other' %}
                                {% if reason_counts.get(reason) %}
                                    {% set _ = reason_counts.update({reason: reason_counts[reason] + 1}) %}
                                {% else %}
                                    {% set _ = reason_counts.update({reason: 1}) %}
                                {% endif %}
                            {% endfor %}
                            
                            {% set total_feedbacks = exit_feedbacks|length %}
                            {% if total_feedbacks > 0 %}
                                {% for reason, count in reason_counts.items() %}
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center p-2 bg-dark bg-opacity-50 rounded">
                                        <span class="text-light">{{ reason[:20] }}{% if reason|length > 20 %}...{% endif %}</span>
                                        <span class="badge bg-primary">{{ ((count / total_feedbacks) * 100)|round|int }}%</span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <p class="text-muted text-center">No exit feedback data available</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Department Breakdown (Real Data) -->
                    <div class="mb-4">
                        <h6 class="text-light mb-3">Department Breakdown</h6>
                        <div class="row g-2">
                            {% set dept_counts = {} %}
                            {% for employee in offboarding_employees %}
                                {% set dept = employee.department or 'Unassigned' %}
                                {% if dept_counts.get(dept) %}
                                    {% set _ = dept_counts.update({dept: dept_counts[dept] + 1}) %}
                                {% else %}
                                    {% set _ = dept_counts.update({dept: 1}) %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if dept_counts %}
                                {% for dept, count in dept_counts.items() %}
                                <div class="col-md-4">
                                    <div class="text-center p-3 bg-dark bg-opacity-50 rounded">
                                        <h5 class="text-primary mb-1">{{ dept[:10] }}{% if dept|length > 10 %}...{% endif %}</h5>
                                        <small class="text-muted">{{ count }} exit{{ 's' if count != 1 else '' }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <p class="text-muted text-center">No offboarding employees data available</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Advanced Section (Hidden by default) -->
    <div id="advancedSection" style="display: none;" class="mt-4">
        <div class="card bg-dark bg-opacity-25 border-secondary">
            <div class="card-header bg-transparent border-secondary">
                <h6 class="text-light mb-0">Advanced Analytics</h6>
            </div>
            <div class="card-body">
                <!-- Employee Specific Details -->
                {% if employee %}
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-light mb-3">Employee Information</h6>
                        <p class="text-muted mb-2"><strong>Department:</strong> {{ employee.department or 'Not Assigned' }}</p>
                        <p class="text-muted mb-2"><strong>Position:</strong> {{ employee.position or 'Not Assigned' }}</p>
                        <p class="text-muted mb-2"><strong>Exit Date:</strong> {{ employee.exit_date.strftime('%B %d, %Y') if employee.exit_date else 'Not Set' }}</p>
                        <p class="text-muted mb-2"><strong>Status:</strong> {{ employee.status }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-light mb-3">Offboarding Details</h6>
                        {% if employee.checklist %}
                        <p class="text-muted mb-2"><strong>Checklist Created:</strong> {{ employee.checklist.created_at.strftime('%B %d, %Y') if employee.checklist.created_at else 'N/A' }}</p>
                        <p class="text-muted mb-2"><strong>Total Tasks:</strong> {{ employee.checklist.tasks | length }}</p>
                        <p class="text-muted mb-2"><strong>Completed:</strong> {{ employee.checklist.tasks | selectattr('is_completed', 'equalto', true) | list | length }}</p>
                        <p class="text-muted mb-2"><strong>Progress:</strong> {{ "%.0f"|format(employee.checklist.get_progress()) }}%</p>
                        {% else %}
                        <p class="text-muted mb-2"><strong>Checklist:</strong> Not Created</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-light mb-3">Detailed Metrics</h6>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-light small">Avg. Exit Time</span>
                                <span class="text-light-50 small">
                                    {% set exit_times = [] %}
                                    {% for emp in offboarding_employees %}
                                        {% if emp.exit_date and emp.hire_date %}
                                            {% set days = (emp.exit_date - emp.hire_date).days %}
                                            {% set _ = exit_times.append(days) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if exit_times %}
                                        {% set avg_time = (exit_times | sum / exit_times | length) | round(1) %}
                                        {{ avg_time }} days
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </div>
                            {% set exit_progress = 0 %}
{% if exit_times %}
    {% set exit_progress = ((avg_time / 365) * 100) | round %}
{% endif %}
<div class="progress bg-dark bg-opacity-50" style="height: 6px;">
    <div class="progress-bar bg-warning" style="width: {{ exit_progress }}%"></div>
</div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-light small">Process Efficiency</span>
                                <span class="text-light-50 small">
                                    {% set completed_tasks = 0 %}
                                    {% set total_tasks = 0 %}
                                    {% for emp in offboarding_employees %}
                                        {% if emp.checklist %}
                                            {% set completed_tasks = completed_tasks + emp.checklist.completed_tasks %}
                                            {% set total_tasks = total_tasks + emp.checklist.total_tasks %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if total_tasks > 0 %}
                                        {{ ((completed_tasks / total_tasks) * 100) | round }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </div>
                            {% set efficiency_progress = 0 %}
{% if total_tasks > 0 %}
    {% set efficiency_progress = ((completed_tasks / total_tasks) * 100) | round %}
{% endif %}
<div class="progress bg-dark bg-opacity-50" style="height: 6px;">
    <div class="progress-bar bg-success" style="width: {{ efficiency_progress }}%"></div>
</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-light mb-3">Trend Analysis</h6>
                        <div class="text-center py-3">
                            {% if exit_feedbacks %}
                                <small class="text-muted">
                                    {{ exit_feedbacks|length }} exit{{ 's' if exit_feedbacks|length != 1 else '' }} in last {{ exit_feedbacks|length }} records
                                </small>
                            {% else %}
                                <small class="text-muted">No exit trend data available</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    // Toggle advanced mode
    function toggleAdvancedMode() {
        const advancedSection = document.getElementById('advancedSection');
        const button = event.target.closest('button');
        
        if (advancedSection.style.display === 'none') {
            advancedSection.style.display = 'block';
            button.innerHTML = '<i class="fas fa-times me-1"></i>Simple';
        } else {
            advancedSection.style.display = 'none';
            button.innerHTML = '<i class="fas fa-cog me-1"></i>Advanced';
        }
    }

    // Task management functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Handle task completion toggle
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('task-action')) {
                e.preventDefault();
                const taskId = e.target.dataset.taskId;
                const completed = e.target.dataset.completed === 'true';
                const action = e.target.dataset.action;
                
                if (action === 'toggle-completion') {
                    toggleTaskCompletion(taskId, completed);
                }
            }
        });

        // Handle checkbox changes
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('task-checkbox')) {
                const taskId = e.target.dataset.taskId;
                const completed = e.target.checked;
                toggleTaskCompletion(taskId, completed);
            }
        });

        // Update progress bar based on completed tasks
        updateProgressBar();
    });

    function toggleTaskCompletion(taskId, completed) {
        fetch(`/api/onboarding/tasks/${taskId}/toggle`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ completed: completed })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI
                const taskRow = document.querySelector(`[data-task-id="${taskId}"]`);
                const checkbox = document.querySelector(`#exitTask${taskId}`);
                const statusBadge = taskRow.querySelector('.badge');
                
                if (completed) {
                    checkbox.checked = true;
                    statusBadge.className = 'badge bg-success bg-opacity-25 text-success';
                    statusBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i> Completed';
                    taskRow.dataset.status = 'completed';
                } else {
                    checkbox.checked = false;
                    statusBadge.className = 'badge bg-secondary bg-opacity-25 text-muted';
                    statusBadge.innerHTML = '<i class="far fa-clock me-1"></i> Pending';
                    taskRow.dataset.status = 'pending';
                }
                
                // Update progress
                updateProgressBar();
                
                // Show success message
                showNotification('Task status updated successfully', 'success');
            } else {
                showNotification('Error updating task status', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error updating task status', 'error');
        });
    }

    function updateProgressBar() {
        const totalTasks = document.querySelectorAll('.task-item').length;
        const completedTasks = document.querySelectorAll('.task-item[data-status="completed"]').length;
        const progressPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        const progressBar = document.getElementById('exitProgressBar');
        const progressText = document.getElementById('progressPercentage');
        
        if (progressBar && progressText) {
            progressBar.style.width = progressPercentage + '%';
            progressBar.setAttribute('aria-valuenow', progressPercentage);
            progressText.textContent = progressPercentage + '%';
        }
        
        // Update completion badge
        const completionBadge = document.querySelector('.badge.bg-primary');
        if (completionBadge) {
            completionBadge.textContent = `${completedTasks}/${totalTasks} Complete`;
        }
    }

    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    // Initialize progress bar animation
    setTimeout(() => {
        updateProgressBar();
    }, 500);
</script>
{% endblock %}
