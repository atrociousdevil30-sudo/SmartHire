{% extends "employee_base.html" %}

{% block title %}Messages{% endblock %}

{% block page_content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="{{ url_for('employee_dashboard') }}" class="btn btn-outline-secondary btn-sm me-3">
                        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                    </a>
                    <div>
                        <h1 class="h3 mb-1 text-light">
                            <i class="fas fa-envelope me-2"></i>Messages
                        </h1>
                        <p class="text-muted mb-0">Communicate with HR team</p>
                    </div>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#composeMessageModal">
                    <i class="fas fa-paper-plane me-1"></i> Compose Message
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- HR Contacts Panel -->
        <div class="col-lg-4">
            <!-- HR Contacts Section -->
            <div class="card bg-dark bg-opacity-25 border-secondary shadow mb-4">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="m-0 text-light">
                        <i class="fas fa-users-cog me-2"></i>HR Contacts
                        <span class="badge bg-danger bg-opacity-25 text-danger ms-2">Strictly Monitored</span>
                    </h6>
                </div>
                <div class="card-body p-0">
                    {% if hr_contacts %}
                    <div class="list-group list-group-flush">
                        {% for hr in hr_contacts %}
                        <div class="list-group-item bg-dark bg-opacity-50 text-light border-secondary hr-contact-item">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 text-light">
                                        {{ hr.full_name }}
                                        {% if hr.full_name == 'Deeksha' %}
                                        <span class="badge bg-warning text-dark ms-2">Primary HR</span>
                                        {% endif %}
                                        <span class="badge bg-primary bg-opacity-25 text-primary ms-2">{{ hr.role.upper() }}</span>
                                    </h6>
                                    <small class="text-muted">{{ hr.position or 'HR Representative' }}</small>
                                    {% if hr.email %}
                                    <br><small class="text-muted">{{ hr.email }}</small>
                                    {% endif %}
                                </div>
                                <div class="ms-auto">
                                    <button class="btn btn-sm btn-outline-primary start-hr-conversation" 
                                        data-hr-id="{{ hr.id }}" 
                                        data-hr-name="{{ hr.full_name }}">
                                        <i class="fas fa-comment me-1"></i>Message
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users-cog fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No HR contacts available</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Employee Contacts Section -->
            <div class="card bg-dark bg-opacity-25 border-secondary shadow mb-4">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="m-0 text-light">
                        <i class="fas fa-users me-2"></i>Employee Contacts
                        <span class="badge bg-success bg-opacity-25 text-success ms-2">Light Monitoring</span>
                    </h6>
                </div>
                <div class="card-body p-0">
                    {% if employee_contacts %}
                    <div class="list-group list-group-flush">
                        {% for emp in employee_contacts %}
                        <div class="list-group-item bg-dark bg-opacity-50 text-light border-secondary employee-contact-item">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">
                                    <i class="bi bi-person"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 text-light">
                                        {{ emp.full_name }}
                                        <span class="badge bg-secondary bg-opacity-25 text-secondary ms-2">{{ emp.role.upper() }}</span>
                                    </h6>
                                    <small class="text-muted">{{ emp.position or 'Employee' }}</small>
                                    {% if emp.department %}
                                    <br><small class="text-muted">{{ emp.department }}</small>
                                    {% endif %}
                                </div>
                                <div class="ms-auto">
                                    <button class="btn btn-sm btn-outline-secondary start-employee-conversation" 
                                        data-employee-id="{{ emp.id }}" 
                                        data-employee-name="{{ emp.full_name }}">
                                        <i class="fas fa-comment me-1"></i>Message
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No employee contacts available</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Conversations List -->
            <div class="card bg-dark bg-opacity-25 border-secondary shadow mb-4">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="m-0 text-light">Recent Conversations</h6>
                </div>
                <div class="card-body p-0">
                    {% if conversations %}
                    <div class="list-group list-group-flush">
                        {% for conversation in conversations %}
                        <a href="#" class="list-group-item list-group-item-action conversation-item bg-dark bg-opacity-50 text-light border-secondary" 
                           data-conversation-id="{{ conversation.user_id }}"
                           data-user-name="{{ conversation.user.full_name or conversation.user.username }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 text-light">
                                    {{ conversation.user.full_name or conversation.user.username }}
                                    {% if conversation.user.role == 'hr' %}
                                    <span class="badge bg-primary bg-opacity-25 text-primary ms-2">HR</span>
                                    {% else %}
                                    <span class="badge bg-secondary bg-opacity-25 text-secondary ms-2">{{ conversation.user.role.upper() }}</span>
                                    {% endif %}
                                </h6>
                                <small class="text-muted">{{ conversation.last_message_time.strftime('%H:%M') if conversation.last_message_time else '' }}</small>
                            </div>
                            <p class="mb-1 text-truncate text-muted">{{ conversation.last_message_content[:50] }}{% if conversation.last_message_content|length > 50 %}...{% endif %}</p>
                            <small class="text-muted">
                                {% if conversation.unread_count > 0 %}
                                <span class="badge bg-danger">{{ conversation.unread_count }} unread</span>
                                {% endif %}
                            </small>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-comments fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No conversations yet</p>
                        <p class="text-muted small">Start a conversation with HR</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Message Thread -->
        <div class="col-lg-8">
            <div class="card bg-dark bg-opacity-25 border-secondary shadow mb-4">
                <div class="card-header bg-transparent border-secondary d-flex justify-content-between align-items-center">
                    <h6 class="m-0 text-light" id="conversationHeader">
                        Select a conversation to view messages
                    </h6>
                    <div id="conversationActions" style="display: none;">
                        <button class="btn btn-sm btn-outline-primary" onclick="replyToMessage()">
                            <i class="fas fa-reply"></i> Reply
                        </button>
                    </div>
                </div>
                <div class="card-body bg-dark bg-opacity-50 p-0" style="height: 500px; overflow-y: auto;">
                    <div id="messageThread" class="p-3">
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Select a conversation</h5>
                            <p class="text-muted">Choose a conversation from the list to start messaging</p>
                        </div>
                    </div>
                </div>
                <!-- Quick Reply -->
                <div class="card-footer bg-transparent border-secondary" id="quickReply" style="display: none;">
                    <form id="replyForm">
                        <div class="input-group">
                            <input type="text" class="form-control bg-dark bg-opacity-50 border-secondary text-light" id="replyMessage" placeholder="Type a message...">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-dark bg-opacity-25 border-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Messages</div>
                            <div class="h5 mb-0 font-weight-bold text-light">{{ total_messages }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-envelope fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-dark bg-opacity-25 border-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Unread Messages</div>
                            <div class="h5 mb-0 font-weight-bold text-light">{{ unread_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-envelope-open-text fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-dark bg-opacity-25 border-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Conversations</div>
                            <div class="h5 mb-0 font-weight-bold text-light">{{ total_conversations }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-comments fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-dark bg-opacity-25 border-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Today</div>
                            <div class="h5 mb-0 font-weight-bold text-light">{{ today_active }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compose Message Modal -->
    <div class="modal fade" id="composeMessageModal" tabindex="-1" aria-labelledby="composeMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header bg-transparent border-secondary">
                    <h5 class="modal-title text-light" id="composeMessageModalLabel">Compose Message</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="composeForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="recipientSelect" class="form-label text-light">To:</label>
                            <select class="form-select bg-dark bg-opacity-50 border-secondary text-light" id="recipientSelect" required>
                                <option value="">Select Contact</option>
                                <optgroup label="HR Contacts (Strictly Monitored)">
                                    {% for hr in hr_contacts %}
                                    <option value="{{ hr.id }}">
                                        {{ hr.full_name }} - {{ hr.position or 'HR Representative' }} ({{ hr.role.upper() }})
                                        {% if hr.full_name == 'Deeksha' %} - Primary HR{% endif %}
                                    </option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="Employee Contacts (Light Monitoring)">
                                    {% for emp in employee_contacts %}
                                    <option value="{{ emp.id }}">
                                        {{ emp.full_name }} - {{ emp.position or 'Employee' }} ({{ emp.role.upper() }})
                                        {% if emp.department %} - {{ emp.department }}{% endif %}
                                    </option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                HR communications are strictly monitored. Employee-to-employee communications have light monitoring.
                            </small>
                        </div>
                        <div class="mb-3">
                            <label for="messageSubject" class="form-label text-light">Subject:</label>
                            <input type="text" class="form-control bg-dark bg-opacity-50 border-secondary text-light" id="messageSubject" placeholder="Enter subject" required>
                        </div>
                        <div class="mb-3">
                            <label for="messageContent" class="form-label text-light">Message:</label>
                            <textarea class="form-control bg-dark bg-opacity-50 border-secondary text-light" id="messageContent" rows="5" placeholder="Type your message..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="priorityMessage">
                                <label class="form-check-label text-light" for="priorityMessage">
                                    Mark as priority message
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-transparent border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-1"></i> Send Message
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div class="modal fade" id="editMessageModal" tabindex="-1" aria-labelledby="editMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header bg-transparent border-secondary">
                    <h5 class="modal-title text-light" id="editMessageModalLabel">Edit Message</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editMessageForm">
                    <div class="modal-body">
                        <input type="hidden" id="editMessageId">
                        <div class="mb-3">
                            <label for="editMessageContent" class="form-label text-light">Message:</label>
                            <textarea class="form-control bg-dark bg-opacity-50 border-secondary text-light" id="editMessageContent" rows="5" placeholder="Edit your message..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Note: The message will show as "edited" to the recipient.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer bg-transparent border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveEditedMessage()">
                            <i class="fas fa-save me-1"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversationId = null;

// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Start conversation with HR contact
function startConversationWithHR(hrId, hrName) {
    // Close compose modal if open
    const composeModal = bootstrap.Modal.getInstance(document.getElementById('composeMessageModal'));
    if (composeModal) {
        composeModal.hide();
    }
    
    // Load conversation
    loadConversation(hrId);
    
    // Show success toast
    showToast('info', 'Conversation Started', `Starting conversation with ${hrName} (HR)`);
}

// Update badge count
function updateBadgeCount() {
    fetch('/api/messages/unread-count')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateUnreadBadge(data.unread_count);
            }
        })
        .catch(error => {
            console.error('Error updating badge count:', error);
        });
}

// Mark messages as read
function markMessagesAsRead(userId) {
    fetch(`/api/messages/mark-read/${userId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrf_token')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('Messages marked as read');
            updateBadgeCount();
        }
    })
    .catch(error => {
        console.error('Error marking messages as read:', error);
    });
}

// Load conversation with a usermployee
function startConversationWithEmployee(empId, empName) {
    // Close compose modal if open
    const composeModal = bootstrap.Modal.getInstance(document.getElementById('composeMessageModal'));
    if (composeModal) {
        composeModal.hide();
    }
    
    // Load conversation
    loadConversation(empId);
    
    // Show success toast
    showToast('info', 'Conversation Started', `Starting conversation with ${empName} (Employee)`);
}

// Handle HR conversation button clicks
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for HR conversation buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.start-hr-conversation')) {
            const button = e.target.closest('.start-hr-conversation');
            const hrId = button.getAttribute('data-hr-id');
            const hrName = button.getAttribute('data-hr-name');
            startConversationWithHR(parseInt(hrId), hrName);
        }
        
        // Add event listener for employee conversation buttons
        if (e.target.closest('.start-employee-conversation')) {
            const button = e.target.closest('.start-employee-conversation');
            const empId = button.getAttribute('data-employee-id');
            const empName = button.getAttribute('data-employee-name');
            startConversationWithEmployee(parseInt(empId), empName);
        }
    });
    
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                console.log('Notification permission granted');
            }
        });
    }
    
    // Add click event listeners to conversation items
    const conversationItems = document.querySelectorAll('.conversation-item');
    conversationItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const conversationId = parseInt(this.getAttribute('data-conversation-id'));
            loadConversation(conversationId);
        });
    });
    
    // Start real-time message checking
    startRealTimeUpdates();
    
    console.log('Employee messaging system loaded with monitoring levels');
});
// Sound notification system
function playNotificationSound() {
    try {
        // Create audio context for notification sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext());
        
        // Create a pleasant notification sound (beep sequence)
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Set frequency for a pleasant notification sound
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        
        // Set volume (not too loud)
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        // Play sound
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
        
        console.log('Notification sound played');
    } catch (error) {
        console.log('Audio notification not supported:', error);
    }
}

// Enhanced message display with sound
function displayNewMessage(message) {
    playNotificationSound();  // Play notification sound
    
    // Update unread badge
    updateBadgeCount();
    
    // Add to conversation list
    addConversationItem(message);
    
    // Show browser notification if permitted
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('New Message from HR', {
            body: message.content.substring(0, 100) + (message.content.length > 100 ? '...' : ''),
            icon: '/static/images/notification-icon.png',
            tag: 'hr-message'
        });
    }
}

// Real-time message checking
let lastMessageCount = 0;
function startRealTimeUpdates() {
    // Check for new messages every 10 seconds
    setInterval(() => {
        checkForNewMessages();
    }, 10000);
}

function checkForNewMessages() {
    fetch('/api/messages/unread-count')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.unread_count > lastMessageCount) {
                // New messages arrived
                const newMessageCount = data.unread_count - lastMessageCount;
                playNotificationSound();  // Play sound for new messages
                
                // Update badge
                updateUnreadBadge(data.unread_count);
                
                // Refresh conversation list if on messages page
                if (window.location.pathname === '/employee/messages') {
                    refreshConversations();
                }
                
                lastMessageCount = data.unread_count;
            }
        })
        .catch(error => console.log('Error checking for new messages:', error));
}

function updateUnreadBadge(count) {
    const messagesLink = document.querySelector('a[href*="messages"]');
    if (messagesLink) {
        const badge = messagesLink.querySelector('.badge');
        if (count > 0) {
            if (badge) {
                badge.textContent = count;
            } else {
                const newBadge = document.createElement('span');
                newBadge.className = 'badge bg-danger';
                newBadge.textContent = count;
                messagesLink.appendChild(newBadge);
            }
        } else if (badge) {
            badge.remove();
        }
    }
}

function refreshConversations() {
    // Refresh the conversation list
    location.reload();
}

// Load conversation
function loadConversation(userId) {
    currentConversationId = userId;
    
    // Update UI
    document.getElementById('conversationHeader').textContent = 'Loading...';
    document.getElementById('messageThread').innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i></div>';
    
    // Fetch messages
    fetch(`/api/messages/conversation/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayMessages(data.messages);
                // Update header with user name from API response
                if (data.user && data.user.full_name) {
                    document.getElementById('conversationHeader').textContent = data.user.full_name;
                } else {
                    updateConversationHeader(userId);
                }
                showQuickReply();
                markMessagesAsRead(userId);
            } else {
                showError('Failed to load conversation');
            }
        })
        .catch(error => {
            console.error('Error loading conversation:', error);
            showError('Error loading conversation');
        });
}

// Display messages
function displayMessages(messages) {
    const messageThread = document.getElementById('messageThread');
    messageThread.innerHTML = '';
    
    console.log('Displaying messages:', messages.length);
    
    messages.forEach(message => {
        console.log('Processing message:', {
            id: message.id,
            sender_name: message.sender_name,
            sender_role: message.sender_role,
            is_sent: message.is_sent
        });
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-container ${message.is_sent ? 'sent' : 'received'} mb-3`;
        messageDiv.setAttribute('data-message-id', message.id);
        
        // Ensure sender information exists and show role
        const senderName = message.is_sent ? 'You' : 
                         (message.sender_name || 'Unknown');
        
        const roleBadge = message.is_sent ? '' : 
                         (message.sender_role ? 
                          `<span class="badge bg-${message.sender_role === 'hr' ? 'primary' : 'secondary'} bg-opacity-25 text-${message.sender_role === 'hr' ? 'primary' : 'secondary'} ms-2">${message.sender_role.toUpperCase()}</span>` : '');
        
        const messageContent = `
            <div class="d-flex ${message.is_sent ? 'justify-content-end' : 'justify-content-start'}">
                <div class="message-card ${message.is_sent ? 'sent-message' : 'received-message'}">
                    <div class="message-header">
                        <span class="sender-name">${senderName}${roleBadge}</span>
                        <span class="message-time">${formatTime(message.sent_at)}</span>
                        ${message.is_sent ? `
                            <div class="dropdown float-end ms-2">
                                <button class="btn btn-sm btn-link text-white-50 p-0" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editMessage(${message.id}, '${message.content.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-edit me-2"></i>Edit Message
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="deleteMessage(${message.id})">
                                        <i class="fas fa-trash me-2"></i>Delete Message
                                    </a></li>
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    <div class="message-body">
                        <div class="message-content">${message.content}</div>
                        ${message.is_edited ? '<div class="message-edited"><i class="fas fa-edit"></i> edited</div>' : ''}
                        ${message.is_priority ? '<div class="message-priority"><i class="fas fa-exclamation-circle"></i> Priority</div>' : ''}
                    </div>
                    <div class="message-footer">
                        ${message.is_sent ? '<i class="fas fa-check-double text-info"></i>' : ''}
                    </div>
                </div>
            </div>
        `;
        
        messageDiv.innerHTML = messageContent;
        messageThread.appendChild(messageDiv);
    });
    
    // Scroll to bottom
    messageThread.scrollTop = messageThread.scrollHeight;
}

// Update conversation header
function updateConversationHeader(userId) {
    const conversationItem = document.querySelector(`[data-conversation-id="${userId}"]`);
    if (conversationItem) {
        // Get the clean user name from data attribute
        const userName = conversationItem.getAttribute('data-user-name');
        if (userName) {
            document.getElementById('conversationHeader').textContent = userName;
        } else {
            // Fallback to getting from h6 element and cleaning it
            const headerElement = conversationItem.querySelector('h6');
            if (headerElement) {
                const cleanName = headerElement.textContent.replace(/HR/g, '').trim();
                document.getElementById('conversationHeader').textContent = cleanName;
            }
        }
    }
}

// Show quick reply
function showQuickReply() {
    document.getElementById('quickReply').style.display = 'block';
    document.getElementById('conversationActions').style.display = 'block';
}

// Reply to message
function replyToMessage() {
    document.getElementById('replyMessage').focus();
}

// Mark messages as read
function markAsRead(userId) {
    fetch(`/api/messages/mark-read/${userId}`, { method: 'PUT' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update unread count
                const badge = document.querySelector(`[data-conversation-id="${userId}"] .badge`);
                if (badge) {
                    badge.remove();
                }
            }
        })
        .catch(error => console.error('Error marking as read:', error));
}

// Edit message function
function editMessage(messageId, currentContent) {
    // Set current editing message
    currentEditingMessageId = messageId;
    
    // Populate edit modal
    document.getElementById('editMessageContent').value = currentContent;
    document.getElementById('editMessageId').value = messageId;
    
    // Show edit modal
    const editModal = new bootstrap.Modal(document.getElementById('editMessageModal'));
    editModal.show();
}

// Delete message function
function deleteMessage(messageId) {
    if (confirm('Are you sure you want to delete this message? This action cannot be undone.')) {
        fetch(`/api/messages/${messageId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Remove message from DOM
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
                showSuccess('Message deleted successfully');
            } else {
                showError('Failed to delete message');
            }
        })
        .catch(error => {
            console.error('Error deleting message:', error);
            showError('Error deleting message');
        });
    }
}

// Save edited message
function saveEditedMessage() {
    const messageId = document.getElementById('editMessageId').value;
    const newContent = document.getElementById('editMessageContent').value;
    
    if (!newContent.trim()) {
        showError('Message content cannot be empty');
        return;
    }
    
    fetch(`/api/messages/${messageId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            content: newContent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Close modal
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editMessageModal'));
            editModal.hide();
            
            // Reload conversation to show updated message
            if (currentConversationId) {
                loadConversation(currentConversationId);
            }
            
            showSuccess('Message updated successfully');
        } else {
            showError('Failed to update message');
        }
    })
    .catch(error => {
        console.error('Error updating message:', error);
        showError('Error updating message');
    });
}

// Send reply
document.getElementById('replyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const messageContent = document.getElementById('replyMessage').value;
    if (!messageContent.trim()) return;
    
    const messageData = {
        recipient_id: currentConversationId,
        content: messageContent,
        message_type: 'message',
        priority: false
    };
    
    fetch('/api/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(messageData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('replyMessage').value = '';
            loadConversation(currentConversationId);
        } else {
            showError('Failed to send message');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error sending message');
    });
});

// Compose message
document.getElementById('composeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const recipientId = document.getElementById('recipientSelect').value;
    const subject = document.getElementById('messageSubject').value;
    const content = document.getElementById('messageContent').value;
    const priority = document.getElementById('priorityMessage').checked;
    
    if (!recipientId || !subject || !content) return;
    
    const messageData = {
        recipient_id: parseInt(recipientId),
        content: `${subject}\n\n${content}`,
        message_type: 'message',
        priority: priority
    };
    
    fetch('/api/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(messageData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('composeMessageModal'));
            modal.hide();
            document.getElementById('composeForm').reset();
            
            // Load conversation if not already loaded
            if (currentConversationId !== parseInt(recipientId)) {
                loadConversation(parseInt(recipientId));
            } else {
                loadConversation(currentConversationId);
            }
            
            // Show success message
            showSuccess('Message sent successfully');
        } else {
            showError('Failed to send message');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error sending message');
    });
});

// Format time
function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

// Show success message
function showSuccess(message) {
    showToast('success', 'Success', message);
}

// Show error message
function showError(message) {
    showToast('danger', 'Error', message);
}

function showToast(type, title, message) {
    // Create toast element
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}:</strong> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // Add toast to container
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toastElement = document.createElement('div');
    toastElement.innerHTML = toastHtml;
    const toast = toastElement.firstElementChild;
    toastContainer.appendChild(toast);
    
    // Initialize and show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove toast after hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}
</script>

<style>
/* WhatsApp-style message layout */
.message-container {
    position: relative;
}

.message-card {
    max-width: 70%;
    border-radius: 12px;
    padding: 8px 12px;
    margin: 4px 0;
    position: relative;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Sent messages (right side) */
.sent-message {
    background: linear-gradient(135deg, #008069 0%, #075e54 100%);
    color: white;
    margin-left: auto;
    border-top-right-radius: 2px;
}

/* Received messages (left side) */
.received-message {
    background: rgba(255, 255, 255, 0.08);
    color: #f8f9fa;
    margin-right: auto;
    border-top-left-radius: 2px;
    border: 1px solid rgba(255, 255, 255, 0.15);
}

/* Message header */
.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
    font-size: 12px;
    opacity: 0.8;
}

.sender-name {
    font-weight: 600;
    margin-right: 8px;
}

.sender-role {
    font-size: 10px;
    opacity: 0.7;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.message-time {
    font-size: 11px;
    opacity: 0.7;
}

/* Message body */
.message-body {
    margin-bottom: 4px;
    line-height: 1.4;
    word-wrap: break-word;
}

.message-content {
    font-size: 14px;
    white-space: pre-wrap;
}

.message-edited {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 2px;
}

.message-priority {
    font-size: 11px;
    color: #ffc107;
    margin-top: 2px;
}

/* Message footer */
.message-footer {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    font-size: 12px;
    opacity: 0.7;
}

/* Conversation list styling */
.conversation-item.active {
    background-color: rgba(13, 110, 253, 0.25) !important;
    border-left: 4px solid #0d6efd;
}

.conversation-item:hover {
    background-color: rgba(255, 255, 255, 0.05) !important;
}

/* Message animations */
.message-container {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Form controls dark theme */
.form-control:focus, .form-select:focus {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: #0d6efd;
    color: #f8f9fa;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

/* Modal dark theme */
.modal-content {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5);
}

/* List group dark theme */
.list-group-item {
    background-color: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.list-group-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

/* Message thread background */
#messageThread {
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23000" opacity="0.02"/><circle cx="50" cy="50" r="40" fill="none" stroke="%23000" stroke-width="0.5" opacity="0.05"/></svg>');
    background-size: 100px 100px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .message-card {
        max-width: 85%;
    }
    
    .message-header {
        font-size: 11px;
    }
    
    .message-content {
        font-size: 13px;
    }
}
</style>
{% endblock %}
