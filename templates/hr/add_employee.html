{% extends "base.html" %}

{% block title %}Add New Employee - SmartHire AI{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-0">
                    <h4 class="text-light mb-0">
                        <i class="fas fa-user-plus me-2"></i> Add New Employee
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_employee') }}">
                        <div class="row">
                            <!-- Personal Information -->
                            <div class="col-md-6">
                                <div class="card bg-dark bg-opacity-25 border-secondary mb-4">
                                    <div class="card-header bg-transparent border-0">
                                        <h5 class="text-light mb-0">Personal Information</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="full_name" class="form-label text-light">Full Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control bg-dark text-light border-secondary" id="full_name" name="full_name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="email" class="form-label text-light">Email <span class="text-danger">*</span></label>
                                            <input type="email" class="form-control bg-dark text-light border-secondary" id="email" name="email" required>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="username" class="form-label text-light">Username <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control bg-dark text-light border-secondary" id="username" name="username" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="password" class="form-label text-light">Temporary Password <span class="text-danger">*</span></label>
                                                    <input type="password" class="form-control bg-dark text-light border-secondary" id="password" name="password" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="phone" class="form-label text-light">Phone Number</label>
                                            <input type="tel" class="form-control bg-dark text-light border-secondary" id="phone" name="phone">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Employment Details -->
                            <div class="col-md-6">
                                <div class="card bg-dark bg-opacity-25 border-secondary mb-4">
                                    <div class="card-header bg-transparent border-0">
                                        <h5 class="text-light mb-0">Employment Details</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="department" class="form-label text-light">Department <span class="text-danger">*</span></label>
                                            <select class="form-select bg-dark text-light border-secondary" id="department" name="department" required>
                                                <option value="" selected disabled>Select Department</option>
                                                <option value="Engineering">Engineering</option>
                                                <option value="Marketing">Marketing</option>
                                                <option value="Sales">Sales</option>
                                                <option value="HR">Human Resources</option>
                                                <option value="Finance">Finance</option>
                                                <option value="Operations">Operations</option>
                                                <option value="Product">Product</option>
                                                <option value="Design">Design</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="position" class="form-label text-light">Position <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control bg-dark text-light border-secondary" id="position" name="position" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="manager_id" class="form-label text-light">Manager</label>
                                            <select class="form-select bg-dark text-light border-secondary" id="manager_id" name="manager_id">
                                                <option value="" selected>No Manager</option>
                                                {% for manager in managers %}
                                                <option value="{{ manager.id }}">{{ manager.full_name }} ({{ manager.department }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="hire_date" class="form-label text-light">Hire Date <span class="text-danger">*</span></label>
                                            <input type="date" class="form-control bg-dark text-light border-secondary" id="hire_date" name="hire_date" required 
                                                   value="{{ now.strftime('%Y-%m-%d') }}">
                                            <small class="text-muted">The date when the employee officially starts working</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Onboarding Checklist Customization -->
                        <div class="card bg-dark bg-opacity-25 border-secondary mb-4">
                            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="text-light mb-0">
                                        <i class="fas fa-clipboard-check me-2"></i> Onboarding Checklist
                                    </h5>
                                </div>
                                <div>
                                    <button type="button" id="generateChecklistBtn" class="btn btn-sm btn-outline-info me-2">
                                        <i class="fas fa-robot me-1"></i> Generate with AI
                                    </button>
                                    <button type="button" id="addTaskBtn" class="btn btn-sm btn-outline-light">
                                        <i class="fas fa-plus me-1"></i> Add Task
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info d-flex align-items-center mb-3" id="aiStatus" style="display: none;">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span id="aiStatusText">Generating checklist with AI...</span>
                                </div>
                                <div id="checklistTasks">
                                    <p class="text-muted small mb-0">Add, remove, or modify onboarding tasks for this employee.</p>
                                </div>
                                <button type="button" class="btn btn-sm btn-primary" id="addTaskBtn">
                                    <i class="fas fa-plus me-1"></i> Add Task
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="checklistTasks">
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="Complete Employment Paperwork" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Review and complete all employment forms, contracts, and legal documents.</textarea>
                                    </div>
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="Document Collection" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Collect ID proof, address proof, and educational certificates.</textarea>
                                    </div>
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="Welcome Email & Handbook" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Send welcome email and employee handbook.</textarea>
                                    </div>
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="ID Card Creation" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Create employee ID card and access badge.</textarea>
                                    </div>
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="Email Account Setup" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Create company email account and configure access.</textarea>
                                    </div>
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="Development Environment Setup" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Install development tools, IDEs, and configure development environment.</textarea>
                                    </div>
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="Code Repository Access" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Grant access to GitHub/GitLab repositories and development tools.</textarea>
                                    </div>
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="Technical Orientation" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Introduction to tech stack, coding standards, and development processes.</textarea>
                                    </div>
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="Laptop & Equipment Assignment" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Assign high-spec laptop, monitor, and development peripherals.</textarea>
                                    </div>
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="Team Introduction Meeting" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Schedule meet-and-greet with immediate team members.</textarea>
                                    </div>
                                    <div class="task-item mb-3 p-3 border border-secondary rounded">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                            <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="First Week Check-in" placeholder="Task name">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)">Schedule check-in meeting to address questions and concerns.</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('list_employees') }}" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-1"></i> Back to Employees
                            </a>
                            <div>
                                <button type="reset" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-undo me-1"></i> Reset
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-user-plus me-1"></i> Add Employee
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // AI Checklist Generation
    document.getElementById('generateChecklistBtn').addEventListener('click', async function() {
        const position = document.getElementById('position').value;
        const department = document.getElementById('department').value;
        const fullName = document.getElementById('full_name').value;
        
        if (!position || !department) {
            alert('Please fill in the position and department fields first.');
            return;
        }
        
        const aiStatus = document.getElementById('aiStatus');
        const aiStatusText = document.getElementById('aiStatusText');
        const checklistTasks = document.getElementById('checklistTasks');
        
        aiStatus.style.display = 'flex';
        aiStatusText.textContent = 'Generating personalized checklist with AI...';
        
        try {
            const response = await fetch('/api/ai/generate-onboarding-checklist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    employee_name: fullName,
                    position: position,
                    department: department
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to generate checklist');
            }
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // Clear existing tasks
                checklistTasks.innerHTML = '';
                
                // Parse the AI response (assuming it returns markdown or text with line breaks)
                const tasks = data.checklist.split('\n').filter(task => task.trim() !== '');
                
                // Add each task to the checklist
                tasks.forEach((task, index) => {
                    if (task.trim() === '') return;
                    
                    const taskId = Date.now() + index;
                    const taskHtml = `
                        <div class="task-item mb-3 p-3 border border-secondary rounded">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                                <input type="hidden" name="task_name[]" value="${task.trim()}">
                                <div class="form-control bg-dark text-light border-0">${task.trim()}</div>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-task">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    checklistTasks.insertAdjacentHTML('beforeend', taskHtml);
                });
                
                // Re-attach event listeners to new elements
                attachTaskEventListeners();
                
                aiStatusText.textContent = 'Checklist generated successfully!';
                setTimeout(() => {
                    aiStatus.style.display = 'none';
                }, 2000);
                
            } else {
                throw new Error(data.message || 'Failed to generate checklist');
            }
            
        } catch (error) {
            console.error('Error generating checklist:', error);
            aiStatusText.textContent = 'Error generating checklist. Please try again.';
            aiStatus.className = 'alert alert-danger d-flex align-items-center mb-3';
        }
    });
    
    function attachTaskEventListeners() {
        // Remove task button
        document.querySelectorAll('.remove-task').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.task-item').remove();
            });
        });
    }
    document.addEventListener('DOMContentLoaded', function() {
        // Generate username from email
        const emailInput = document.getElementById('email');
        const usernameInput = document.getElementById('username');
        
        emailInput.addEventListener('blur', function() {
            if (emailInput.value && !usernameInput.value) {
                const username = emailInput.value.split('@')[0].toLowerCase();
                usernameInput.value = username.replace(/[^a-z0-9]/g, '');
            }
        });
        
        // Generate random password
        const generatePassword = () => {
            const length = 12;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]:;?><,./-=";
            let password = "";
            
            // Ensure at least one of each character type
            password += "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random() * 26));
            password += "abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(Math.random() * 26));
            password += "0123456789".charAt(Math.floor(Math.random() * 10));
            password += "!@#$%^&*()_+~`|}{[]:;?><,./-=".charAt(Math.floor(Math.random() * 26));
            
            // Fill the rest of the password
            for (let i = 4; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            
            // Shuffle the password
            return password.split('').sort(() => 0.5 - Math.random()).join('');
        };
        
        // Set random password
        const passwordInput = document.getElementById('password');
        passwordInput.value = generatePassword();
        
        // Onboarding checklist management
        const addTaskBtn = document.getElementById('addTaskBtn');
        const checklistTasks = document.getElementById('checklistTasks');
        
        // Add new task
        addTaskBtn.addEventListener('click', function() {
            const taskHtml = `
                <div class="task-item mb-3 p-3 border border-secondary rounded">
                    <div class="d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-3" name="task_enabled[]" value="1" checked>
                        <input type="text" class="form-control bg-dark text-light border-secondary me-2" name="task_name[]" value="" placeholder="Task name">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <textarea class="form-control bg-dark text-light border-secondary mt-2" name="task_description[]" rows="2" placeholder="Task description (optional)"></textarea>
                </div>
            `;
            checklistTasks.insertAdjacentHTML('beforeend', taskHtml);
        });
        
        // Remove task
        checklistTasks.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-task') || e.target.closest('.remove-task')) {
                const taskItem = e.target.closest('.task-item');
                if (checklistTasks.children.length > 1) {
                    taskItem.remove();
                } else {
                    alert('At least one task is required for onboarding.');
                }
            }
        });
    });
</script>
{% endblock %}
