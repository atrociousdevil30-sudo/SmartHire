{% extends "base.html" %}

{% block title %}HR Dashboard - SmartHire AI{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- HR User Info Header (Simplified) -->
    <div class="card bg-dark bg-opacity-25 border-secondary mb-4">
        <div class="card-body py-3">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <div class="avatar-lg bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-user-tie"></i>
                    </div>
                </div>
                <div class="flex-grow-1">
                    <h5 class="mb-1 text-light">Welcome, {{ user.full_name }}</h5>
                    <p class="mb-0 text-muted small">HR Manager</p>
                </div>
                <div>
                    <button class="btn btn-outline-light btn-sm" onclick="toggleAdvancedMode()">
                        <i class="fas fa-cog me-1"></i>Advanced
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions (Primary Focus) -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="text-light mb-3">Quick Actions</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <a href="{{ url_for('add_employee') }}" class="card card-simplified h-100 text-decoration-none">
                        <div class="card-body text-center p-3">
                            <i class="fas fa-user-plus fa-2x text-primary mb-2"></i>
                            <h6 class="text-light">Add Employee</h6>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{{ url_for('onboarding') }}" class="card card-simplified h-100 text-decoration-none">
                        <div class="card-body text-center p-3">
                            <i class="fas fa-user-clock fa-2x text-success mb-2"></i>
                            <h6 class="text-light">Onboarding</h6>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{{ url_for('interview') }}" class="card card-simplified h-100 text-decoration-none">
                        <div class="card-body text-center p-3">
                            <i class="fas fa-robot fa-2x text-info mb-2"></i>
                            <h6 class="text-light">AI Interview</h6>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{{ url_for('list_employees') }}" class="card card-simplified h-100 text-decoration-none">
                        <div class="card-body text-center p-3">
                            <i class="fas fa-users fa-2x text-warning mb-2"></i>
                            <h6 class="text-light">Employees</h6>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics (Simplified) -->
    <div class="row mb-4" id="keyMetrics">
        <div class="col-12">
            <h5 class="text-light mb-3">Overview</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card card-simplified">
                        <div class="card-body text-center p-3">
                            <h3 class="text-light mb-1">{{ total_employees or 0 }}</h3>
                            <small class="text-muted">Total Employees</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-simplified">
                        <div class="card-body text-center p-3">
                            <h3 class="text-success mb-1">{{ onboarding_count or 0 }}</h3>
                            <small class="text-muted">Onboarding</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-simplified">
                        <div class="card-body text-center p-3">
                            <h3 class="text-warning mb-1">{{ pending_tasks or 0 }}</h3>
                            <small class="text-muted">Pending Tasks</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-simplified">
                        <div class="card-body text-center p-3">
                            <h3 class="text-info mb-1">{{ completed_interviews or 0 }}</h3>
                            <small class="text-muted">Interviews</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Section (Hidden by default) -->
    <div id="advancedSection" style="display: none;">
        <div class="row mb-4">
            <div class="col-12">
                <h5 class="text-light mb-3">HR Insights & Strategy</h5>
                <div class="card bg-dark bg-opacity-25 border-secondary">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-light mb-3">Recent Activity</h6>
                                <div class="list-group list-group-flush">
                                    {% if interview_results %}
                                        {% for interview in interview_results[:2] %}
                                        <div class="list-group-item bg-transparent border-secondary">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-light">Interview with {{ interview.candidate_name }}</span>
                                                <small class="text-muted">{{ interview.date }}</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if onboarding_count > 0 %}
                                    <div class="list-group-item bg-transparent border-secondary">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-light">{{ onboarding_count }} employee{{ 's' if onboarding_count != 1 else '' }} onboarding</span>
                                            <small class="text-muted">Active now</small>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if recent_interviews|length == 0 and onboarding_count == 0 %}
                                    <div class="list-group-item bg-transparent border-secondary">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">No recent activity</span>
                                            <small class="text-muted">-</small>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-light mb-3">Upcoming</h6>
                                <div class="list-group list-group-flush">
                                    {% if upcoming_exits %}
                                        {% for exit in upcoming_exits[:2] %}
                                        <div class="list-group-item bg-transparent border-secondary">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-light">Exit interview: {{ exit.name }}</span>
                                                <small class="text-muted">
                                                    {% if exit.days == 0 %}Today
                                                    {% elif exit.days == 1 %}Tomorrow
                                                    {% else %}In {{ exit.days }} days
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if upcoming_goals %}
                                        {% for goal in upcoming_goals[:2] %}
                                        <div class="list-group-item bg-transparent border-secondary">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-light">{{ goal.type }} ({{ goal.count }} employee{{ 's' if goal.count != 1 else '' }})</span>
                                                <small class="text-muted">{{ goal.timeframe }}</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if upcoming_exits|length == 0 and upcoming_goals|length == 0 %}
                                    <div class="list-group-item bg-transparent border-secondary">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">No upcoming events</span>
                                            <small class="text-muted">-</small>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Analytics (Advanced) -->
        <div class="row">
            <div class="col-md-6">
                <div class="card bg-dark bg-opacity-25 border-secondary">
                    <div class="card-header bg-transparent border-secondary">
                        <h6 class="text-light mb-0">Employee Distribution</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="employeeChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-dark bg-opacity-25 border-secondary">
                    <div class="card-header bg-transparent border-secondary">
                        <h6 class="text-light mb-0">Onboarding Progress</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="onboardingChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for advanced mode toggle and charts -->
<script>
    function toggleAdvancedMode() {
        const advancedSection = document.getElementById('advancedSection');
        const button = event.target.closest('button');
        
        if (advancedSection.style.display === 'none') {
            advancedSection.style.display = 'block';
            button.innerHTML = '<i class="fas fa-times me-1"></i>Simple';
        } else {
            advancedSection.style.display = 'none';
            button.innerHTML = '<i class="fas fa-cog me-1"></i>Advanced';
        }
    }

    // Initialize charts with real data
    document.addEventListener('DOMContentLoaded', function() {
        // Employee Distribution Chart
        const employeeCtx = document.getElementById('employeeChart');
        if (employeeCtx) {
            try {
                // Department data from server
                const departmentData = JSON.parse('{{ departments|tojson|safe }}');
                console.log('Department data:', departmentData);
                
                // Use fallback data if no real data
                let deptLabels, deptCounts;
                if (departmentData && departmentData.length > 0) {
                    deptLabels = departmentData.map(d => d[0] || 'Unassigned');
                    deptCounts = departmentData.map(d => d[1]);
                } else {
                    // Fallback data
                    deptLabels = ['No Departments', 'Engineering', 'Sales', 'HR'];
                    deptCounts = [0, 0, 0, 0];
                }
                
                console.log('Department labels:', deptLabels);
                console.log('Department counts:', deptCounts);
                
                new Chart(employeeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: deptLabels,
                        datasets: [{
                            data: deptCounts,
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#fff',
                                    padding: 10
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating employee distribution chart:', error);
                // Show error message on chart
                employeeCtx.parentElement.innerHTML = '<div class="text-center text-muted py-5">Error loading department data</div>';
            }
        }

        // Onboarding Progress Chart
        const onboardingCtx = document.getElementById('onboardingChart');
        if (onboardingCtx) {
            try {
                // Employee count data from server
                const onboardingCount = parseInt('{{ onboarding_count }}') || 0;
                const activeCount = parseInt('{{ active_count }}') || 0;
                const totalEmployees = parseInt('{{ total_employees }}') || 0;
                const otherCount = totalEmployees - onboardingCount - activeCount;
                
                console.log('Employee counts:', { onboardingCount, activeCount, totalEmployees, otherCount });
                
                new Chart(onboardingCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Onboarding', 'Active', 'Other'],
                        datasets: [{
                            label: 'Employees',
                            data: [onboardingCount, activeCount, otherCount],
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#fff',
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#fff'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating onboarding progress chart:', error);
                // Show error message on chart
                onboardingCtx.parentElement.innerHTML = '<div class="text-center text-muted py-5">Error loading employee data</div>';
            }
        }
    });
</script>

    {% endblock %}
