{% extends "base.html" %}

{% block title %}Knowledge Transfer System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h1 class="h3 mb-1 text-light">
                                <i class="fas fa-brain me-2"></i>Knowledge Transfer System
                            </h1>
                            <p class="text-muted mb-0">Document critical processes and ensure smooth transition</p>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-column align-items-md-end mt-3 mt-md-0">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-info" id="startKTTour">
                                        <i class="fas fa-question-circle me-1"></i> Guide Tour
                                    </button>
                                    <button class="btn btn-sm btn-outline-light" id="exportKTReport">
                                        <i class="fas fa-download me-1"></i> Export KT Report
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" id="completeKT">
                                        <i class="fas fa-check-circle me-1"></i> Complete Transfer
                                    </button>
                                    <a href="{{ url_for('exit_interview') }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-1"></i> Back to Exit
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Knowledge Transfer Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-tasks me-2"></i>Transfer Progress
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h3 class="mb-1 text-primary" id="sessionsCompleted">{{ kt_progress.sessions_completed }}</h3>
                                    <p class="text-muted small mb-0">Sessions Completed</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h3 class="mb-1 text-success" id="docsUploaded">{{ kt_progress.docs_uploaded }}</h3>
                                    <p class="text-muted small mb-0">Documents Uploaded</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h3 class="mb-1 text-warning" id="successorTrained">{{ kt_progress.successor_trained_percent }}%</h3>
                                    <p class="text-muted small mb-0">Successor Trained</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h3 class="mb-1 text-info" id="projectsHandover">{{ kt_progress.projects_handover }}</h3>
                                    <p class="text-muted small mb-0">Projects Handover</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Structured Knowledge Transfer Sessions -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-chalkboard-teacher me-2"></i>Structured Knowledge Transfer Sessions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Session Topic</th>
                                    <th>Attendees</th>
                                    <th>Scheduled Date</th>
                                    <th>Status</th>
                                    <th>Documentation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ktSessionsTable">
                                {% for session in kt_sessions %}
                                <tr>
                                    <td>
                                        <div>
                                            <strong>{{ session.session_topic }}</strong>
                                            <br><small class="text-muted">{{ session.description or 'No description available' }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ session.attendees }}</span>
                                    </td>
                                    <td>{{ session.scheduled_date.strftime('%Y-%m-%d') if session.scheduled_date else 'Not scheduled' }}</td>
                                    <td>
                                        {% if session.status == 'Completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif session.status == 'In Progress' %}
                                            <span class="badge bg-info">In Progress</span>
                                        {% elif session.status == 'Cancelled' %}
                                            <span class="badge bg-danger">Cancelled</span>
                                        {% else %}
                                            <span class="badge bg-warning">Scheduled</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if session.documentation_path %}
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-upload"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-success me-1">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No knowledge transfer sessions scheduled yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <button class="btn btn-outline-primary mt-3" id="addKTSession">
                        <i class="fas fa-plus me-1"></i> Add Session
                    </button>
                </div>
            </div>
        </div>

        <!-- Critical Processes Documentation -->
        <div class="col-lg-4">
            <div class="card bg-dark bg-opacity-25 border-secondary mb-4">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="mb-0 text-light">
                        <i class="fas fa-file-alt me-2"></i>Critical Processes Documentation
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label text-light small">Upload Process Documents</label>
                        <input type="file" class="form-control form-control-sm" id="processDocs" multiple accept=".pdf,.doc,.docx,.txt">
                    </div>
                    
                    <div class="list-group" id="uploadedDocs">
                        {% for document in kt_documents %}
                        <div class="list-group-item bg-dark bg-opacity-50 border-secondary">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    {% if document.file_type.lower() == 'pdf' %}
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                    {% elif document.file_type.lower() in ['doc', 'docx'] %}
                                        <i class="fas fa-file-word text-primary me-2"></i>
                                    {% elif document.file_type.lower() == 'txt' %}
                                        <i class="fas fa-file-alt text-info me-2"></i>
                                    {% else %}
                                        <i class="fas fa-file text-secondary me-2"></i>
                                    {% endif %}
                                    <span class="text-light">{{ document.document_name }}</span>
                                    {% if document.category %}
                                        <small class="text-muted">({{ document.category }})</small>
                                    {% endif %}
                                </div>
                                <button class="btn btn-sm btn-outline-danger" data-document-id="{{ document.id }}" onclick="deleteDocument(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="list-group-item bg-dark bg-opacity-50 border-secondary">
                            <div class="text-center text-muted">
                                <i class="fas fa-folder-open me-2"></i>
                                No documents uploaded yet
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-light small">Documentation Progress</span>
                            <span class="badge bg-success">80%</span>
                        </div>
                        <div class="progress bg-dark bg-opacity-50" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: 80%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Successor Training Tracking -->
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="mb-0 text-light">
                        <i class="fas fa-user-graduate me-2"></i>Successor Training Tracking
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label text-light small">Assigned Successor</label>
                        <input type="text" class="form-control form-control-sm" id="successorName" placeholder="Enter successor name">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-light small">Training Progress</label>
                        <div class="progress bg-dark bg-opacity-50" style="height: 20px;">
                            <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" id="successorProgress" data-progress="{{ kt_progress.successor_trained_percent }}" style="width: 0%">{{ kt_progress.successor_trained_percent }}%</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-light small">Training Modules</label>
                        {% for training in successor_training %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="module{{ training.id }}" {% if training.status == 'Completed' %}checked{% endif %}>
                            <label class="form-check-label text-light small" for="module{{ training.id }}">
                                {{ training.training_module }} ({{ training.status }})
                                {% if training.completion_date %}
                                    <small class="text-muted">- Completed {{ training.completion_date.strftime('%Y-%m-%d') }}</small>
                                {% endif %}
                            </label>
                        </div>
                        {% else %}
                        <div class="text-muted small">No training modules assigned yet</div>
                        {% endfor %}
                    </div>
                    
                    <button class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-certificate me-1"></i> Generate Training Certificate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Handover Verification -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-project-diagram me-2"></i>Project Handover Verification
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>Project Name</th>
                                            <th>Status</th>
                                            <th>Handover Date</th>
                                            <th>Recipient</th>
                                            <th>Documentation</th>
                                            <th>Verification</th>
                                        </tr>
                                    </thead>
                                    <tbody id="projectsTable">
                                        {% for project in project_handovers %}
                                        <tr>
                                            <td>
                                                <strong>{{ project.project_name }}</strong>
                                                {% if project.project_description %}
                                                    <br><small class="text-muted">{{ project.project_description }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if project.status == 'Completed' %}
                                                    <span class="badge bg-success">Completed</span>
                                                {% elif project.status == 'In Progress' %}
                                                    <span class="badge bg-warning">In Progress</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Pending</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ project.handover_date.strftime('%Y-%m-%d') if project.handover_date else 'Not set' }}</td>
                                            <td>{{ project.recipient_name }}</td>
                                            <td>
                                                {% if project.documentation_path %}
                                                    <button class="btn btn-sm btn-outline-primary" data-project-id="{{ project.id }}" data-project-name="{{ project.project_name }}" onclick="viewProjectDocs(this)">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="verify{{ project.id }}" {% if project.verified %}checked{% endif %}>
                                                    <label class="form-check-label" for="verify{{ project.id }}">Verified</label>
                                                </div>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">No projects in handover process</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <button class="btn btn-outline-primary mt-3" id="addProject">
                                <i class="fas fa-plus me-1"></i> Add Project
                            </button>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card bg-dark bg-opacity-10 border-secondary">
                                <div class="card-body">
                                    <h6 class="text-light mb-3">Handover Checklist</h6>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-light small">Source Code Access</span>
                                            <span class="badge bg-success">âœ“</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-light small">Documentation Complete</span>
                                            <span class="badge bg-warning">âš </span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-light small">Client Introduction</span>
                                            <span class="badge bg-success">âœ“</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-light small">Password Transfer</span>
                                            <span class="badge bg-secondary">â—‹</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-light small">Timeline Handover</span>
                                            <span class="badge bg-success">âœ“</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-light small">Budget Transfer</span>
                                            <span class="badge bg-warning">âš </span>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-sm btn-outline-success w-100">
                                        <i class="fas fa-clipboard-check me-1"></i> Complete Verification
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Knowledge Transfer Summary -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-clipboard-list me-2"></i>Knowledge Transfer Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="text-light mb-3">Transfer Completion Status</h6>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-light small">Overall Progress</span>
                                    <span class="badge bg-primary">75%</span>
                                </div>
                                <div class="progress bg-dark bg-opacity-50" style="height: 8px;">
                                    <div class="progress-bar bg-primary" style="width: 75%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-light small">Critical Knowledge Transfer</span>
                                    <span class="badge bg-success">90%</span>
                                </div>
                                <div class="progress bg-dark bg-opacity-50" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: 90%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-light small">Documentation Completeness</span>
                                    <span class="badge bg-warning">60%</span>
                                </div>
                                <div class="progress bg-dark bg-opacity-50" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: 60%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-light mb-3">Risk Assessment</h6>
                            <div class="alert alert-warning bg-dark bg-opacity-25 border-warning">
                                <h6 class="alert-heading text-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Medium Risk Areas
                                </h6>
                                <ul class="text-light small mb-0">
                                    <li>Client relationship handover needs verification</li>
                                    <li>Advanced system training incomplete</li>
                                    <li>Budget authority transfer pending</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add KT Session Modal -->
<div class="modal fade" id="addKTSessionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Add Knowledge Transfer Session</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ktSessionForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Session Topic</label>
                            <input type="text" class="form-control" id="sessionTopic" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Attendees</label>
                            <input type="text" class="form-control" id="sessionAttendees" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Scheduled Date</label>
                            <input type="date" class="form-control" id="sessionDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Duration (hours)</label>
                            <input type="number" class="form-control" id="sessionDuration" min="0.5" step="0.5" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="sessionDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveKTSession">Save Session</button>
            </div>
        </div>
    </div>
</div>

<style>
.progress-bar-striped {
    background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
    background-size: 1rem 1rem;
}

.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position-x: 1rem; }
}

.list-group-item {
    border: 1px solid #495057;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.alert {
    border: 1px solid;
}

.alert-warning {
    color: #ffc107;
    background-color: rgba(255, 193, 7, 0.1);
}

.badge {
    font-size: 0.75em;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Knowledge Transfer Tutorial System
    function startKTTour() {
        // Create tour overlay
        const tourOverlay = document.createElement('div');
        tourOverlay.id = 'ktTourOverlay';
        tourOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        // Create tour content
        const tourContent = document.createElement('div');
        tourContent.style.cssText = `
            background: #2c3e50;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            color: white;
            position: relative;
        `;
        
        tourContent.innerHTML = `
            <button id="closeTourBtn" style="
                position: absolute;
                top: 10px;
                right: 15px;
                background: #e74c3c;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
            ">&times;</button>
            
            <h2 style="color: #3498db; margin-bottom: 20px;">
                <i class="fas fa-brain"></i> Knowledge Transfer System Guide
            </h2>
            
            <div class="tour-section" style="margin-bottom: 25px;">
                <h3 style="color: #f39c12; margin-bottom: 10px;">
                    <i class="fas fa-tasks"></i> What is Knowledge Transfer?
                </h3>
                <p style="line-height: 1.6;">
                    Knowledge Transfer (KT) is the process of documenting and sharing critical information, 
                    processes, and expertise when employees join or leave the organization. This ensures 
                    business continuity and preserves valuable organizational knowledge.
                </p>
            </div>
            
            <div class="tour-section" style="margin-bottom: 25px;">
                <h3 style="color: #f39c12; margin-bottom: 10px;">
                    <i class="fas fa-chart-line"></i> Transfer Progress Overview
                </h3>
                <p style="line-height: 1.6;">
                    The progress cards at the top show your personal KT completion status:
                </p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li><strong>Sessions Completed:</strong> Number of KT sessions you've attended</li>
                    <li><strong>Documents Uploaded:</strong> Files you've shared for knowledge transfer</li>
                    <li><strong>Successor Trained:</strong> Progress of training your replacement</li>
                    <li><strong>Projects Handover:</strong> Projects you've successfully transferred</li>
                </ul>
            </div>
            
            <div class="tour-section" style="margin-bottom: 25px;">
                <h3 style="color: #f39c12; margin-bottom: 10px;">
                    <i class="fas fa-chalkboard-teacher"></i> Structured KT Sessions
                </h3>
                <p style="line-height: 1.6;">
                    This table shows scheduled knowledge transfer sessions:
                </p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li><strong>Session Topic:</strong> What will be discussed</li>
                    <li><strong>Attendees:</strong> Who participates in the session</li>
                    <li><strong>Status:</strong> Scheduled, In Progress, or Completed</li>
                    <li><strong>Actions:</strong> View documentation or mark as complete</li>
                </ul>
            </div>
            
            <div class="tour-section" style="margin-bottom: 25px;">
                <h3 style="color: #f39c12; margin-bottom: 10px;">
                    <i class="fas fa-file-alt"></i> Critical Process Documentation
                </h3>
                <p style="line-height: 1.6;">
                    Upload and manage important documents that contain critical processes, 
                    procedures, and institutional knowledge. These documents are essential 
                    for training new team members and ensuring continuity.
                </p>
            </div>
            
            <div class="tour-section" style="margin-bottom: 25px;">
                <h3 style="color: #f39c12; margin-bottom: 10px;">
                    <i class="fas fa-user-graduate"></i> Successor Training
                </h3>
                <p style="line-height: 1.6;">
                    Track the training progress of your successor or replacement. Mark completed 
                    training modules to ensure proper knowledge transfer and skill development.
                </p>
            </div>
            
            <div class="tour-section" style="margin-bottom: 25px;">
                <h3 style="color: #f39c12; margin-bottom: 10px;">
                    <i class="fas fa-project-diagram"></i> Project Handover
                </h3>
                <p style="line-height: 1.6;">
                    Manage the transfer of ongoing projects to ensure they continue smoothly 
                    after your departure. Document project status, deliverables, and key contacts.
                </p>
            </div>
            
            <div class="tour-section" style="margin-bottom: 25px;">
                <h3 style="color: #27ae60; margin-bottom: 10px;">
                    <i class="fas fa-lightbulb"></i> Best Practices
                </h3>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>Start KT process early (at least 2-3 weeks before departure)</li>
                    <li>Document processes step-by-step with screenshots</li>
                    <li>Schedule regular sessions with your successor</li>
                    <li>Get confirmation from recipients for each handover</li>
                    <li>Update documentation regularly until final day</li>
                </ul>
            </div>
            
            <div class="tour-section" style="margin-bottom: 20px;">
                <h3 style="color: #e74c3c; margin-bottom: 10px;">
                    <i class="fas fa-exclamation-triangle"></i> Important Notes
                </h3>
                <p style="line-height: 1.6;">
                    <strong>For HR:</strong> You can see all KT activities across the organization.<br>
                    <strong>For Employees:</strong> You see only your personal KT activities.<br>
                    <strong>Data Privacy:</strong> Your KT data is visible only to authorized personnel.
                </p>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="startUsingKTBtn" style="
                    background: #3498db;
                    border: none;
                    color: white;
                    padding: 12px 30px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                    margin-right: 10px;
                ">
                    <i class="fas fa-check"></i> Got it, Start Using KT
                </button>
                <button id="quickTourBtn" style="
                    background: #95a5a6;
                    border: none;
                    color: white;
                    padding: 12px 30px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                ">
                    <i class="fas fa-rocket"></i> Quick Tour
                </button>
            </div>
        `;
        
        tourOverlay.appendChild(tourContent);
        document.body.appendChild(tourOverlay);
        
        // Add event listeners to buttons after DOM insertion
        document.getElementById('closeTourBtn').addEventListener('click', closeTour);
        document.getElementById('startUsingKTBtn').addEventListener('click', closeTour);
        document.getElementById('quickTourBtn').addEventListener('click', showQuickTour);
    }
    
    function closeTour() {
        const overlay = document.getElementById('ktTourOverlay');
        if (overlay) {
            overlay.remove();
        }
    }
    
    function showQuickTour() {
        closeTour();
        // Highlight each section sequentially
        const sections = [
            {
                element: document.querySelector('.card:has(#sessionsCompleted)'),
                title: 'Progress Overview',
                message: 'Your personal KT progress at a glance'
            },
            {
                element: document.querySelector('#ktSessionsTable'),
                title: 'KT Sessions',
                message: 'Your scheduled knowledge transfer sessions'
            },
            {
                element: document.querySelector('#ktDocumentsTable'),
                title: 'Documentation',
                message: 'Critical process documents you\'ve uploaded'
            },
            {
                element: document.querySelector('#successorTraining'),
                title: 'Successor Training',
                message: 'Track your replacement\'s training progress'
            },
            {
                element: document.querySelector('#projectsTable'),
                title: 'Project Handover',
                message: 'Projects you\'re transferring to others'
            }
        ];
        
        let currentIndex = 0;
        
        function highlightSection(index) {
            if (index >= sections.length) {
                showTourComplete();
                return;
            }
            
            const section = sections[index];
            if (!section.element) {
                highlightSection(index + 1);
                return;
            }
            
            // Remove previous highlights
            document.querySelectorAll('.tour-highlight').forEach(el => {
                el.classList.remove('tour-highlight');
            });
            
            // Highlight current section
            section.element.classList.add('tour-highlight');
            section.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'tour-tooltip';
            tooltip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #3498db;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10001;
                max-width: 300px;
                text-align: center;
                box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            `;
            tooltip.innerHTML = `
                <h4 style="margin: 0 0 10px 0;">${section.title}</h4>
                <p style="margin: 0;">${section.message}</p>
                <button onclick="nextSection()" style="
                    background: white;
                    color: #3498db;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 4px;
                    cursor: pointer;
                    margin-top: 10px;
                ">Next â†’</button>
            `;
            
            document.body.appendChild(tooltip);
            currentIndex = index;
        }
        
        window.nextSection = function() {
            const tooltip = document.querySelector('.tour-tooltip');
            if (tooltip) tooltip.remove();
            highlightSection(currentIndex + 1);
        };
        
        function showTourComplete() {
            const completeMsg = document.createElement('div');
            completeMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #27ae60;
                color: white;
                padding: 20px;
                border-radius: 8px;
                z-index: 10001;
                text-align: center;
                box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            `;
            completeMsg.innerHTML = `
                <h3 style="margin: 0 0 10px 0;">Tour Complete! ðŸŽ‰</h3>
                <p style="margin: 0;">You're now ready to use the Knowledge Transfer system effectively.</p>
                <button onclick="this.parentElement.remove()" style="
                    background: white;
                    color: #27ae60;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 4px;
                    cursor: pointer;
                    margin-top: 10px;
                ">Got it!</button>
            `;
            document.body.appendChild(completeMsg);
            
            // Remove highlights
            document.querySelectorAll('.tour-highlight').forEach(el => {
                el.classList.remove('tour-highlight');
            });
        }
        
        // Add CSS for highlights
        const style = document.createElement('style');
        style.textContent = `
            .tour-highlight {
                border: 3px solid #3498db !important;
                border-radius: 8px !important;
                box-shadow: 0 0 20px rgba(52, 152, 219, 0.5) !important;
                transition: all 0.3s ease !important;
            }
        `;
        document.head.appendChild(style);
        
        highlightSection(0);
    }
    
    // Add tour button click handler
    const tourBtn = document.getElementById('startKTTour');
    if (tourBtn) {
        tourBtn.addEventListener('click', startKTTour);
    }
    
    // Helper functions for data attribute handling
    function deleteDocument(button) {
        const documentId = button.getAttribute('data-document-id');
        if (documentId && confirm('Are you sure you want to delete this document?')) {
            // Add delete logic here
            console.log('Deleting document:', documentId);
            // You can add an API call here to actually delete the document
        }
    }
    
    function viewProjectDocs(button) {
        const projectId = button.getAttribute('data-project-id');
        const projectName = button.getAttribute('data-project-name');
        if (projectId && projectName) {
            // Add view logic here
            console.log('Viewing project docs:', projectId, projectName);
            // You can add logic to view project documentation here
        }
    }
    
    // Initialize progress bar from data attribute
    const successorProgress = document.getElementById('successorProgress');
    if (successorProgress) {
        const progress = successorProgress.getAttribute('data-progress');
        if (progress) {
            successorProgress.style.width = progress + '%';
        }
    }
    
    // Update successor training progress
    function updateSuccessorProgress() {
        const checkboxes = document.querySelectorAll('#successorTraining input[type="checkbox"]');
        const checked = document.querySelectorAll('#successorTraining input[type="checkbox"]:checked');
        const progress = Math.round((checked.length / checkboxes.length) * 100);
        
        const progressBar = document.getElementById('successorProgress');
        progressBar.style.width = progress + '%';
        progressBar.textContent = progress + '%';
        
        document.getElementById('successorTrained').textContent = progress + '%';
    }

    // Add event listeners for training modules
    document.querySelectorAll('#successorTraining input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateSuccessorProgress);
    });

    // Add KT Session Modal
    const addKTSessionBtn = document.getElementById('addKTSession');
    const ktSessionModal = new bootstrap.Modal(document.getElementById('addKTSessionModal'));
    
    addKTSessionBtn.addEventListener('click', function() {
        ktSessionModal.show();
    });

    // Save KT Session
    document.getElementById('saveKTSession').addEventListener('click', function() {
        const form = document.getElementById('ktSessionForm');
        if (form.checkValidity()) {
            // Add session to table
            const table = document.getElementById('ktSessionsTable');
            const newRow = table.insertRow();
            
            newRow.innerHTML = `
                <td>
                    <div>
                        <strong>${document.getElementById('sessionTopic').value}</strong>
                        <br><small class="text-muted">${document.getElementById('sessionDescription').value}</small>
                    </div>
                </td>
                <td>
                    <span class="badge bg-secondary">${document.getElementById('sessionAttendees').value}</span>
                </td>
                <td>${document.getElementById('sessionDate').value}</td>
                <td><span class="badge bg-warning">Scheduled</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-upload"></i>
                    </button>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-success me-1">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            `;
            
            // Update sessions count
            const sessionsCount = table.rows.length;
            document.getElementById('sessionsCompleted').textContent = sessionsCount;
            
            ktSessionModal.hide();
            form.reset();
        }
    });

    // Export KT Report
    document.getElementById('exportKTReport').addEventListener('click', function() {
        alert('Knowledge Transfer report exported successfully!');
    });

    // Complete Knowledge Transfer
    document.getElementById('completeKT').addEventListener('click', function() {
        if (confirm('Are you sure you want to complete the knowledge transfer process?')) {
            alert('Knowledge Transfer completed successfully!');
            window.location.href = '{{ url_for("exit_interview") }}';
        }
    });

    // Initialize progress
    updateSuccessorProgress();
    
    // Set initial values
    document.getElementById('sessionsCompleted').textContent = '3';
    document.getElementById('docsUploaded').textContent = '2';
    document.getElementById('projectsHandover').textContent = '3';
});
</script>

<!-- Project Documentation View Modal -->
<div class="modal fade" id="projectDocsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-project-diagram me-2"></i>Project Documentation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="projectDetails">
                    <!-- Project details will be loaded here -->
                </div>
                
                <div class="mt-4">
                    <h6 class="text-light mb-3">Available Documentation</h6>
                    <div id="projectDocsList">
                        <!-- Documentation list will be loaded here -->
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6 class="text-light mb-3">Handover Checklist</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sourceCodeAccess" checked>
                                <label class="form-check-label text-light" for="sourceCodeAccess">
                                    Source Code Access Transferred
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="documentationComplete">
                                <label class="form-check-label text-light" for="documentationComplete">
                                    Documentation Complete
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="clientIntroduction" checked>
                                <label class="form-check-label text-light" for="clientIntroduction">
                                    Client Introduction Complete
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="passwordTransfer">
                                <label class="form-check-label text-light" for="passwordTransfer">
                                    Passwords/Credentials Transferred
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="timelineHandover" checked>
                                <label class="form-check-label text-light" for="timelineHandover">
                                    Timeline/Deliverables Handover
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="budgetTransfer">
                                <label class="form-check-label text-light" for="budgetTransfer">
                                    Budget Authority Transferred
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6 class="text-light mb-3">Handover Notes</h6>
                    <textarea class="form-control bg-dark text-light border-secondary" id="handoverNotes" rows="3" placeholder="Add any additional notes about the handover process..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadAllDocs">
                    <i class="fas fa-download me-1"></i> Download All Documents
                </button>
                <button type="button" class="btn btn-success" id="markHandoverComplete">
                    <i class="fas fa-check-circle me-1"></i> Mark Handover Complete
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// View Project Documentation
function viewProjectDocs(projectId, projectName) {
    // Fetch project data from API
    fetch(`/api/project/${projectId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error loading project details: ' + data.error);
                return;
            }
            
            // Update modal content with real data
            document.getElementById('projectDetails').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p class="text-muted small mb-1">Project Name</p>
                        <h6 class="text-light">${data.name}</h6>
                    </div>
                    <div class="col-md-6">
                        <p class="text-muted small mb-1">Status</p>
                        <span class="badge bg-${data.status === 'Completed' ? 'success' : data.status === 'In Progress' ? 'warning' : 'secondary'}">${data.status}</span>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <p class="text-muted small mb-1">Handover Date</p>
                        <p class="text-light">${data.handover_date || 'Not set'}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="text-muted small mb-1">Recipient</p>
                        <p class="text-light">${data.recipient}</p>
                    </div>
                </div>
                <div class="mt-3">
                    <p class="text-muted small mb-1">Description</p>
                    <p class="text-light">${data.description}</p>
                </div>
                <div class="mt-3">
                    <p class="text-muted small mb-1">Verification Status</p>
                    <span class="badge bg-${data.verified ? 'success' : 'secondary'}">${data.verified ? 'Verified' : 'Not Verified'}</span>
                </div>
            `;
            
            // Update documents list
            let docsHtml = '';
            data.documents.forEach(doc => {
                const icon = doc.type === 'pdf' ? 'fa-file-pdf text-danger' : 
                            doc.type === 'docx' ? 'fa-file-word text-primary' : 
                            'fa-file-alt text-info';
                
                docsHtml += `
                    <div class="list-group-item bg-dark bg-opacity-50 border-secondary mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas ${icon} me-2"></i>
                                <span class="text-light">${doc.name}</span>
                                <small class="text-muted ms-2">${doc.size}</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="downloadDocument('${doc.path}', '${doc.name}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="previewDocument('${doc.path}', '${doc.name}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('projectDocsList').innerHTML = docsHtml || '<p class="text-muted">No documents available</p>';
            
            // Update handover notes if they exist
            if (data.notes) {
                document.getElementById('handoverNotes').value = data.notes;
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('projectDocsModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load project details');
        });
}

// Download Document
function downloadDocument(path, name) {
    alert(`Downloading ${name} from ${path}`);
    // In a real implementation, this would trigger an actual download
    window.open(path, '_blank');
}

// Preview Document
function previewDocument(path, name) {
    alert(`Previewing ${name}`);
    // In a real implementation, this would open a preview modal or new tab
    window.open(path, '_blank');
}

// Download All Documents
document.getElementById('downloadAllDocs').addEventListener('click', function() {
    alert('Downloading all project documents...');
    // In a real implementation, this would create a zip file of all documents
});

// Mark Handover Complete
document.getElementById('markHandoverComplete').addEventListener('click', function() {
    if (confirm('Are you sure you want to mark this handover as complete?')) {
        alert('Handover marked as complete!');
        bootstrap.Modal.getInstance(document.getElementById('projectDocsModal')).hide();
        // In a real implementation, this would update the database
        location.reload();
    }
});
</script>
{% endblock %}
