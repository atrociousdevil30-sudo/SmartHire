{% extends "employee_base.html" %}

{% block title %}Onboarding Tasks - SmartHire AI{% endblock %}

{% block page_content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="bi bi-clipboard2-check me-2"></i>Onboarding Tasks
                </h1>
                <a href="{{ url_for('employee_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
                </a>
            </div>
            <p class="text-muted mb-0">Complete these tasks to finish your onboarding process</p>
        </div>
    </div>

    <!-- Progress Overview -->
    {% if checklist %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <h5 class="text-light mb-2">Your Onboarding Progress</h5>
                            <div class="progress bg-dark bg-opacity-50 mb-2" style="height: 10px;">
                                <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     data-progress="{{ checklist.get_progress() }}"
                                     aria-valuenow="{{ checklist.get_progress() }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">{{ "%.0f"|format(checklist.get_progress()) }}% Complete</small>
                                {% set pending_count = checklist.tasks|selectattr('is_completed', 'equalto', false)|list|length %}
                                {% if pending_count > 0 %}
                                <small class="text-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i> {{ pending_count }} task{{ 's' if pending_count > 1 else '' }} pending
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-wrap justify-content-md-end gap-2">
                                <div class="border-end pe-3 me-3">
                                    <h6 class="text-light mb-1">{{ checklist.tasks|length }}</h6>
                                    <small class="text-muted">Total Tasks</small>
                                </div>
                                <div class="border-end pe-3 me-3">
                                    <h6 class="text-success mb-1">{{ checklist.tasks|selectattr('is_completed', 'equalto', true)|list|length }}</h6>
                                    <small class="text-muted">Completed</small>
                                </div>
                                <div class="border-end pe-3 me-3">
                                    <h6 class="text-warning mb-1">{{ checklist.tasks|selectattr('is_completed', 'equalto', false)|list|length }}</h6>
                                    <small class="text-muted">Pending</small>
                                </div>
                                <div>
                                    <h6 class="text-info mb-1">{{ ((now.date() - user.hire_date).days if user.hire_date else 0) }}</h6>
                                    <small class="text-muted">Days Since Start</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Task Categories -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card bg-dark bg-opacity-25 border-secondary h-100">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="bi bi-file-earmark-text fs-1"></i>
                    </div>
                    <h5 class="card-title">Documentation</h5>
                    <p class="small text-muted">Upload and submit required documents</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-dark bg-opacity-25 border-secondary h-100">
                <div class="card-body text-center">
                    <div class="text-warning mb-2">
                        <i class="bi bi-person-lines-fill fs-1"></i>
                    </div>
                    <h5 class="card-title">Personal Information</h5>
                    <p class="small text-muted">Complete your personal details</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-dark bg-opacity-25 border-secondary h-100">
                <div class="card-body text-center">
                    <div class="text-info mb-2">
                        <i class="bi bi-play-circle fs-1"></i>
                    </div>
                    <h5 class="card-title">Orientation</h5>
                    <p class="small text-muted">Complete orientation materials</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Task List -->
    <div class="card bg-dark bg-opacity-25 border-secondary mb-4">
        <div class="card-header bg-transparent border-0">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">
                    <i class="bi bi-list-check me-2"></i>Your Tasks
                </h2>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-funnel me-1"></i> Filter
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="filterDropdown">
                        <li><a class="dropdown-item" href="#" onclick="filterTasks('all')">All Tasks</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterTasks('pending')">Pending</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterTasks('completed')">Completed</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="filterTasks('issues')">Issues</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th width="40"></th>
                            <th>Task</th>
                            <th>Category</th>
                            <th>Due Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tasksList">
                        {% if checklist and checklist.tasks %}
                            {% for task in checklist.tasks %}
                            <tr class="task-item" data-status="{{ 'completed' if task.is_completed else 'pending' }}" data-task-id="{{ task.id }}">
                                <td class="text-center">
                                    <div class="form-check">
                                        <input class="form-check-input task-checkbox" type="checkbox" 
                                               id="task{{ task.id }}" 
                                               data-task-id="{{ task.id }}" 
                                               {{ 'checked' if task.is_completed else '' }}>
                                    </div>
                                </td>
                                <td>
                                    <label class="form-check-label" for="task{{ task.id }}">
                                        {{ task.task_name }}
                                        {% if task.task_description %}
                                        <small class="d-block text-muted">{{ task.task_description }}</small>
                                        {% endif %}
                                        {% if task.hr_resolution_note %}
                                        <div class="mt-1">
                                            <small class="text-success">
                                                <i class="fas fa-info-circle me-1"></i>HR Note: {{ task.hr_resolution_note }}
                                            </small>
                                        </div>
                                        {% endif %}
                                    </label>
                                </td>
                                <td>
                                    {% set category = 'Documentation' if 'document' in task.task_name.lower() or 'upload' in task.task_name.lower() or 'aadhaar' in task.task_name.lower() or 'pan' in task.task_name.lower() or 'bank' in task.task_name.lower() else 'Personal Information' if 'personal' in task.task_name.lower() or 'information' in task.task_name.lower() or 'form' in task.task_name.lower() else 'Orientation' %}
                                    <span class="badge bg-secondary bg-opacity-25">{{ category }}</span>
                                </td>
                                <td>
                                    {% if task.due_date %}
                                        <span>{{ task.due_date.strftime('%b %d, %Y') }}</span>
                                    {% else %}
                                        <span>{{ (checklist.created_at + timedelta(days=task.order_index + 3)).strftime('%b %d, %Y') }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.is_completed %}
                                        <span class="badge bg-success">Completed</span>
                                        {% if task.completed_at %}
                                        <small class="d-block text-muted">{{ task.completed_at.strftime('%b %d, %Y') }}</small>
                                        {% endif %}
                                    {% elif task.has_issue %}
                                        <span class="badge bg-danger">Issue Reported</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-clipboard2-check fa-2x mb-2"></i>
                                    <p>No onboarding tasks available. Please contact HR.</p>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="card bg-dark bg-opacity-25 border-secondary mb-4">
        <div class="card-header bg-transparent border-0">
            <h2 class="h5 mb-0">
                <i class="bi bi-chat-left-text me-2"></i>Comments & Questions
            </h2>
        </div>
        <div class="card-body">
            <div id="commentsSection">
                {% if checklist and checklist.tasks %}
                    {% for task in checklist.tasks %}
                        {% if task.employee_comment %}
                        <div class="d-flex mb-3">
                            <div class="flex-shrink-0 me-3">
                                <div class="avatar avatar-sm bg-primary bg-opacity-10 text-primary rounded-circle">
                                    <i class="bi bi-person-fill"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="card bg-dark bg-opacity-50 p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <strong>You</strong>
                                        <small class="text-muted">{{ task.updated_at.strftime('%b %d, %Y %H:%M') if task.updated_at else 'Recently' }}</small>
                                    </div>
                                    <p class="mb-0"><strong>{{ task.task_name }}:</strong> {{ task.employee_comment }}</p>
                                    {% if task.hr_resolution_note %}
                                    <div class="mt-2 pt-2 border-top border-secondary">
                                        <small class="text-success">
                                            <strong>HR Response:</strong> {{ task.hr_resolution_note }}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            
            <form id="commentForm">
                <div class="mb-3">
                    <label for="comment" class="form-label">Add a comment or question</label>
                    <textarea class="form-control bg-dark text-light" id="comment" rows="3" placeholder="Type your message here..." autocomplete="off"></textarea>
                </div>
                <div class="d-flex justify-content-between">
                    <div class="form-text">Your message will be visible to the HR team</div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send me-1"></i> Send
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentTaskId = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Set progress bar width from data attribute
        const progressBar = document.querySelector('.progress-bar[data-progress]');
        if (progressBar) {
            const progress = progressBar.getAttribute('data-progress');
            progressBar.style.width = `${progress}%`;
        }

        // Handle comment form submission
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitComment();
            });
        }

        // Event delegation for task checkboxes
        const tasksList = document.getElementById('tasksList');
        if (tasksList) {
            tasksList.addEventListener('change', function(e) {
                if (e.target.classList.contains('task-checkbox')) {
                    const taskId = e.target.getAttribute('data-task-id');
                    const isChecked = e.target.checked;
                    updateTaskStatus(taskId, isChecked);
                }
            });
        }
    });

    // Update task status in real-time
    function updateTaskStatus(taskId, isCompleted) {
        fetch(`/api/employee/onboarding/tasks/${taskId}/toggle`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ completed: isCompleted })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update UI in real-time
                const taskRow = document.querySelector(`tr[data-task-id="${taskId}"]`);
                if (taskRow) {
                    const statusBadge = taskRow.querySelector('.badge');
                    const checkbox = taskRow.querySelector('.task-checkbox');
                    
                    if (isCompleted) {
                        statusBadge.className = 'badge bg-success';
                        statusBadge.textContent = 'Completed';
                        checkbox.checked = true;
                        taskRow.dataset.status = 'completed';
                    } else {
                        statusBadge.className = 'badge bg-warning text-dark';
                        statusBadge.textContent = 'Pending';
                        checkbox.checked = false;
                        taskRow.dataset.status = 'pending';
                    }
                    
                    // Update progress
                    updateProgress();
                }
            } else {
                console.error('Failed to update task:', data.message);
                // Revert checkbox state
                const checkbox = document.querySelector(`#task${taskId}`);
                if (checkbox) checkbox.checked = !isCompleted;
            }
        })
        .catch(error => {
            console.error('Error updating task:', error);
            // Revert checkbox state
            const checkbox = document.querySelector(`#task${taskId}`);
            if (checkbox) checkbox.checked = !isCompleted;
        });
    }

    // Submit comment
    function submitComment() {
        const comment = document.getElementById('comment').value;
        
        if (!comment.trim()) {
            showToast('Please enter a comment.', 'error');
            return;
        }
        
        if (comment.trim().length < 5) {
            showToast('Comment must be at least 5 characters long.', 'error');
            return;
        }
        
        // Show loading state
        const submitBtn = document.querySelector('#commentForm .btn-primary');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Sending...';
        submitBtn.disabled = true;
        
        fetch('/api/employee/onboarding/comment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                comment: comment
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Clear form
                document.getElementById('comment').value = '';
                
                // Show success
                showToast('Comment sent successfully. HR team will respond shortly.', 'success');
                
                // Optionally add comment to UI immediately (for better UX)
                // This would require the API to return the comment data
            } else {
                showToast('Failed to send comment: ' + (data.message || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error sending comment:', error);
            showToast('Failed to send comment. Please try again.', 'error');
        })
        .finally(() => {
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }

    // Update progress
    function updateProgress() {
        const totalTasks = document.querySelectorAll('#tasksList tr[data-task-id]').length;
        const completedTasks = document.querySelectorAll('#tasksList tr[data-status="completed"]').length;
        const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        // Update progress bar
        const progressBar = document.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
        }
        
        // Update counters
        const completedCount = document.querySelector('.text-success');
        const pendingCount = document.querySelector('.text-warning');
        
        if (completedCount) completedCount.textContent = completedTasks;
        if (pendingCount) pendingCount.textContent = totalTasks - completedTasks;
    }

    // Filter tasks
    function filterTasks(filter) {
        const tasks = document.querySelectorAll('#tasksList .task-item');
        
        tasks.forEach(task => {
            const status = task.dataset.status;
            const hasIssue = task.querySelector('.bg-danger');
            
            let show = false;
            
            switch(filter) {
                case 'all':
                    show = true;
                    break;
                case 'pending':
                    show = status === 'pending' && !hasIssue;
                    break;
                case 'completed':
                    show = status === 'completed';
                    break;
                case 'issues':
                    show = hasIssue !== null;
                    break;
            }
            
            task.style.display = show ? '' : 'none';
        });
        
        // Update active filter button
        document.querySelectorAll('#filterDropdown .dropdown-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`#filterDropdown .dropdown-item[onclick*="${filter}"]`).classList.add('active');
    }

    // Toast notification helper
    function showToast(message, type = 'info') {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Add toast and show it
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = toastContainer.lastElementChild;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Remove toast after it's hidden
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }
</script>
{% endblock %}
