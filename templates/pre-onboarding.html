{% extends "base.html" %}

{% block title %}Onboarding - SmartHire AI{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12 mb-4">
            <h1 class="h3 mb-4">Candidate Onboarding</h1>
            <p class="text-muted">Add new candidates to the system and analyze their resumes against job descriptions.</p>
        </div>
    </div>
    
    <div class="row">
        <!-- Left Column - Sample Candidates -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Sample Candidates</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for candidate in sample_candidates %}
                        <a href="#" class="list-group-item list-group-item-action sample-candidate" 
                           data-name="{{ candidate.name }}" 
                           data-job="{{ candidate.job_desc }}"
                           data-resume="{{ candidate.resume_text|replace('\n', '\\n')|replace('"', '\\"')|replace("'", "\\'") }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ candidate.name }}</h6>
                                <small class="badge bg-{{ 'success' if candidate.score >= 80 else 'warning' if candidate.score >= 60 else 'danger' }}">
                                    {{ "%.1f"|format(candidate.score) }}%
                                </small>
                            </div>
                            <p class="mb-1 text-muted small">{{ candidate.job_desc }}</p>
                            {% if candidate.summary %}
                            <p class="mb-0 small text-muted">{{ candidate.summary[:100] }}{% if candidate.summary|length > 100 %}...{% endif %}</p>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">Click on a sample to fill the form</small>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Onboarding Form -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">New Candidate Onboarding</h2>
                </div>
                <div class="card-body">
                    <form id="analysisForm">
                        <div class="mb-3">
                            <label for="candidateName" class="form-label">Candidate Name</label>
                            <input type="text" class="form-control" id="candidateName" required>
                        </div>
                        <div class="mb-3">
                            <label for="jobDescription" class="form-label">Job Description</label>
                            <textarea class="form-control" id="jobDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="resumeText" class="form-label mb-0">Resume Text</label>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="clearForm">
                                    <i class="fas fa-eraser me-1"></i>Clear Form
                                </button>
                            </div>
                            <textarea class="form-control font-monospace" id="resumeText" rows="10" required 
                                      placeholder="Paste the candidate's resume text here..."></textarea>
                            <div class="form-text">For best results, use plain text format (no images or tables).</div>
                        </div>
                        <div class="d-grid">
                            <button type="button" id="analyzeBtn" class="btn btn-primary">
                                <span id="analyzeText">Analyze Resume</span>
                                <span id="analyzeSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

            <div id="resultCard" class="card d-none mt-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h3 class="h5 mb-0">Analysis Results</h3>
                    <button id="startOnboardingBtn" class="btn btn-sm btn-light d-none">
                        <i class="bi bi-person-check-fill me-1"></i> Start Onboarding
                    </button>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="h6 text-muted mb-1">AI Summary</h4>
                            <p id="aiSummary" class="mb-0"></p>
                        </div>
                        <div class="col-md-6">
                            <h4 class="h6 text-muted mb-1">Match Score</h4>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-3" style="height: 20px;">
                                    <div id="scoreProgress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <span id="scoreValue" class="fw-bold">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-secondary" id="startInterviewBtn">
                                <i class="bi bi-chat-left-text me-2"></i>Start AI Interview
                            </button>
                            <div>
                            <button class="btn btn-outline-primary me-2" id="saveCandidateBtn">
                                <i class="bi bi-save me-2"></i>Save Candidate
                            </button>
                            <button class="btn btn-primary" id="notifyItBtn">
                                <i class="bi bi-bell me-2"></i>Notify IT Department
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/onboarding.js') }}"></script>
<script>
    // Hiring threshold (adjust as needed)
    const HIRING_THRESHOLD = 70;

    document.addEventListener('DOMContentLoaded', function() {
        const startOnboardingBtn = document.getElementById('startOnboardingBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultCard = document.getElementById('resultCard');
        const resultScore = document.getElementById('scoreValue');
        const resultSummary = document.getElementById('aiSummary');
        const candidateName = document.getElementById('candidateName');
        const jobDescription = document.getElementById('jobDescription');
        const resumeText = document.getElementById('resumeText');
        
        // Make sample candidates clickable
        const sampleCandidates = document.querySelectorAll('.sample-candidate');
        sampleCandidates.forEach(candidate => {
            candidate.addEventListener('click', function(e) {
                e.preventDefault();
                // Remove active class from all candidates
                sampleCandidates.forEach(c => c.classList.remove('active', 'bg-light', 'text-dark'));
                // Add active class to clicked candidate
                this.classList.add('active', 'bg-light', 'text-dark');
                
                // Auto-fill the form with candidate data
                const name = this.dataset.name;
                const job = this.dataset.job;
                const resume = this.dataset.resume.replace(/\\n/g, '\n');
                
                if (candidateName) candidateName.value = name;
                if (jobDescription) jobDescription.value = job;
                if (resumeText) resumeText.value = resume;
                
                // Reset analysis state
                if (resultCard) resultCard.classList.add('d-none');
                if (analyzeBtn) analyzeBtn.disabled = false;
            });
        });
        
        // Handle analyze button click
        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', function() {
                const activeCandidate = document.querySelector('.sample-candidate.active');
                if (!activeCandidate) {
                    alert('Please select a candidate first');
                    return;
                }
                
                // Show loading state
                const analyzeText = analyzeBtn.querySelector('#analyzeText');
                const analyzeSpinner = analyzeBtn.querySelector('#analyzeSpinner');
                analyzeBtn.disabled = true;
                analyzeText.textContent = 'Analyzing...';
                analyzeSpinner.classList.remove('d-none');
                
                // Simulate analysis with progress updates
                const totalSteps = 5;
                let currentStep = 0;
                
                // Reset UI state
                if (resultCard) resultCard.classList.add('d-none');
                if (startOnboardingBtn) startOnboardingBtn.classList.add('d-none');
                
                const progressInterval = setInterval(() => {
                    currentStep++;
                    const progress = Math.min(100, Math.round((currentStep / totalSteps) * 100));
                    
                    // Update progress bar
                    const progressBar = document.getElementById('scoreProgress');
                    if (progressBar) {
                        progressBar.style.width = `${progress}%`;
                        progressBar.setAttribute('aria-valuenow', progress);
                        document.getElementById('scoreValue').textContent = `${progress}%`;
                    }
                    
                    // Update status text
                    if (analyzeText) {
                        const statuses = [
                            'Analyzing resume...',
                            'Matching skills...',
                            'Evaluating experience...',
                            'Checking references...',
                            'Finalizing analysis...'
                        ];
                        if (currentStep <= statuses.length) {
                            analyzeText.textContent = statuses[currentStep - 1];
                        }
                    }
                    
                    // When analysis is complete
                    if (currentStep >= totalSteps) {
                        clearInterval(progressInterval);
                        
                        // Generate final score (60-90)
                        const score = Math.floor(Math.random() * 30) + 60;
                        const summary = score >= HIRING_THRESHOLD 
                            ? 'This candidate meets our hiring criteria. You may proceed with onboarding.'
                            : 'This candidate does not meet the minimum score requirement for this position.';
                        
                        // Update UI with final results
                        if (resultScore) resultScore.textContent = `${score}%`;
                        if (resultSummary) resultSummary.textContent = summary;
                        if (resultCard) resultCard.classList.remove('d-none');
                        
                        // Update progress bar color based on score
                        if (progressBar) {
                            progressBar.style.width = `${score}%`;
                            progressBar.setAttribute('aria-valuenow', score);
                            
                            if (score >= 80) {
                                progressBar.className = 'progress-bar bg-success';
                            } else if (score >= 60) {
                                progressBar.className = 'progress-bar bg-warning';
                            } else {
                                progressBar.className = 'progress-bar bg-danger';
                            }
                        }
                        
                        // Show/hide start onboarding button based on score
                        if (startOnboardingBtn) {
                            if (score >= HIRING_THRESHOLD) {
                                startOnboardingBtn.classList.remove('d-none');
                            } else {
                                startOnboardingBtn.classList.add('d-none');
                            }
                        }
                        
                        // Reset button state
                        analyzeText.textContent = 'Re-analyze Resume';
                        analyzeSpinner.classList.add('d-none');
                        analyzeBtn.disabled = false;
                    }
                }, 800); // Update progress every 800ms
            });
        }
        
        // Handle start onboarding button click
        if (startOnboardingBtn) {
            startOnboardingBtn.addEventListener('click', function() {
                const activeCandidate = document.querySelector('.sample-candidate.active');
                if (activeCandidate) {
                    // Get all candidate data
                    const candidateData = {
                        id: activeCandidate.dataset.id,
                        name: activeCandidate.dataset.name,
                        email: activeCandidate.dataset.email || '',
                        position: activeCandidate.dataset.job,
                        resume: activeCandidate.dataset.resume.replace(/\\n/g, '\n')
                    };
                    
                    // Store candidate data in sessionStorage
                    sessionStorage.setItem('selectedCandidate', JSON.stringify(candidateData));
                    
                    // Navigate to onboarding page
                    window.location.href = '/onboarding';
                }
            });
        }
    });
</script>
{% endblock %}
