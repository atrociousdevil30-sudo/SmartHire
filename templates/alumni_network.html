{% extends "base.html" %}

{% block title %}Alumni Network Management{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h1 class="h3 mb-1 text-light">
                                <i class="fas fa-users me-2"></i>Alumni Network Management
                            </h1>
                            <p class="text-muted mb-0">Maintain relationships and leverage alumni potential</p>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-column align-items-md-end mt-3 mt-md-0">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-light" id="exportAlumniData">
                                        <i class="fas fa-download me-1"></i> Export Alumni Data
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" id="bulkOutreach">
                                        <i class="fas fa-envelope me-1"></i> Bulk Outreach
                                    </button>
                                    <a href="{{ url_for('hr_dashboard') }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alumni Network Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-chart-line me-2"></i>Network Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h3 class="mb-1 text-primary" id="totalAlumni">{{ alumni_stats.total_alumni if alumni_stats else 0 }}</h3>
                                    <p class="text-muted small mb-0">Total Alumni</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h3 class="mb-1 text-success" id="activeAlumni">{{ alumni_stats.active_alumni if alumni_stats else 0 }}</h3>
                                    <p class="text-muted small mb-0">Active Alumni</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h3 class="mb-1 text-warning" id="rehirePotential">{{ alumni_stats.rehire_potential if alumni_stats else 0 }}</h3>
                                    <p class="text-muted small mb-0">Rehire Potential</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h3 class="mb-1 text-info" id="brandAmbassadors">{{ alumni_stats.brand_ambassadors if alumni_stats else 0 }}</h3>
                                    <p class="text-muted small mb-0">Brand Ambassadors</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Additional Statistics Row -->
                    <div class="row g-4 mt-1">
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h5 class="mb-1 text-secondary">{{ alumni_stats.total_interactions if alumni_stats else 0 }}</h5>
                                    <p class="text-muted small mb-0">Total Interactions</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h5 class="mb-1 text-info">{{ alumni_stats.recent_interactions if alumni_stats else 0 }}</h5>
                                    <p class="text-muted small mb-0">Recent (30 days)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h5 class="mb-1 text-warning">{{ alumni_stats.high_priority_rehire if alumni_stats else 0 }}</h5>
                                    <p class="text-muted small mb-0">High Priority</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark bg-opacity-10 border-secondary text-center">
                                <div class="card-body">
                                    <h5 class="mb-1 text-danger">{{ alumni_stats.lost_contact_alumni if alumni_stats else 0 }}</h5>
                                    <p class="text-muted small mb-0">Lost Contact</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alumni Profiles and Management -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-address-book me-2"></i>Alumni Profiles
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <input type="text" class="form-control form-control-sm" id="searchAlumni" placeholder="Search alumni...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="lost_contact">Lost Contact</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="industryFilter">
                                    <option value="">All Industries</option>
                                    <option value="technology">Technology</option>
                                    <option value="finance">Finance</option>
                                    <option value="healthcare">Healthcare</option>
                                    <option value="education">Education</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-outline-primary w-100" id="addAlumni">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Current Position</th>
                                    <th>Industry</th>
                                    <th>Status</th>
                                    <th>Last Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alumniTable">
                                {% for alumni in alumni_profiles %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                {{ alumni.current_company[0].upper() if alumni.current_company else 'A' }}
                                            </div>
                                            <div>
                                                <strong>{{ alumni.user.full_name if alumni.user else 'Unknown' }}</strong>
                                                {% if alumni.linkedin_url %}
                                                <a href="{{ alumni.linkedin_url }}" target="_blank" class="text-muted small ms-1">
                                                    <i class="fab fa-linkedin"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-light">{{ alumni.current_position or 'N/A' }}</span>
                                        <br><small class="text-muted">{{ alumni.current_company or 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ alumni.industry or 'Unknown' }}</span>
                                    </td>
                                    <td>
                                        {% if alumni.alumni_status == 'active' %}
                                            <span class="badge bg-success">Active</span>
                                        {% elif alumni.alumni_status == 'inactive' %}
                                            <span class="badge bg-warning">Inactive</span>
                                        {% else %}
                                            <span class="badge bg-danger">Lost Contact</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set last_contact = alumni.last_contact_date() %}
                                        {% if last_contact %}
                                            <span class="text-light">{{ last_contact.strftime('%Y-%m-%d') }}</span>
                                        {% else %}
                                            <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-info" onclick="viewAlumniDetails('{{ alumni.id }}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-primary" onclick="editAlumni('{{ alumni.id }}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-success" onclick="recordInteraction('{{ alumni.id }}')">
                                                <i class="fas fa-phone"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No alumni profiles found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rehire Potential Tracking -->
        <div class="col-lg-4">
            <div class="card bg-dark bg-opacity-25 border-secondary mb-4">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="mb-0 text-light">
                        <i class="fas fa-redo me-2"></i>Top Rehire Candidates
                    </h6>
                </div>
                <div class="card-body">
                    <div id="rehireCandidates">
                        {% for rehire_potential, alumni_profile, user in rehire_candidates %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong class="text-light">{{ user.full_name if user else 'Unknown' }}</strong>
                                <br><small class="text-muted">{{ alumni_profile.current_position or 'N/A' }}</small>
                                <br><small class="text-muted">{{ alumni_profile.current_company or 'N/A' }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">{{ rehire_potential.rehire_score }}/100</span>
                                <br><small class="text-muted">{{ rehire_potential.rehire_status }}</small>
                                <br><small class="text-muted">{{ alumni_profile.industry or 'Unknown' }}</small>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-user-tie me-2"></i>
                            No rehire candidates identified
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button class="btn btn-sm btn-outline-primary w-100 mt-3" id="viewAllRehire">
                        <i class="fas fa-list me-1"></i> View All Rehire Candidates
                    </button>
                </div>
            </div>

            <!-- Brand Ambassador Management -->
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="mb-0 text-light">
                        <i class="fas fa-star me-2"></i>Brand Ambassadors
                    </h6>
                </div>
                <div class="card-body">
                    <div id="brandAmbassadorsList">
                        {% for ambassador, alumni_profile, user in brand_ambassadors %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong class="text-light">{{ user.full_name if user else 'Unknown' }}</strong>
                                <br><small class="text-muted">{{ ambassador.ambassador_type or 'General' }}</small>
                                <br><small class="text-muted">{{ alumni_profile.current_company or 'N/A' }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success">{{ ambassador.engagement_level }}</span>
                                <br><small class="text-muted">{{ ambassador.referral_count }} referrals</small>
                                <br><small class="text-muted">Score: {{ ambassador.brand_alignment_score }}/100</small>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-megaphone me-2"></i>
                            No brand ambassadors active
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button class="btn btn-sm btn-outline-success w-100 mt-3" id="manageAmbassadors">
                        <i class="fas fa-crown me-1"></i> Manage Ambassadors
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Interactions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-comments me-2"></i>Recent Alumni Interactions
                    </h5>
                </div>
                <div class="card-body">
                    <div id="recentInteractions">
                        {% for interaction, alumni_profile, user in recent_interactions %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong class="text-light">{{ user.full_name if user else 'Unknown' }}</strong>
                                <br><small class="text-muted">
                                    <span class="badge bg-secondary">{{ interaction.interaction_type }}</span>
                                    {% if interaction.interaction_purpose %}
                                    <span class="badge bg-info ms-1">{{ interaction.interaction_purpose }}</span>
                                    {% endif %}
                                </small>
                                <br><small class="text-muted">{{ interaction.interaction_notes[:100] }}{% if interaction.interaction_notes|length > 100 %}...{% endif %}</small>
                            </div>
                            <div class="text-end">
                                <span class="text-light">{{ interaction.interaction_date.strftime('%Y-%m-%d') }}</span>
                                <br><small class="text-muted">By: {{ interaction.created_by if interaction.created_by else 'HR' }}</small>
                                {% if interaction.response_received %}
                                <br><span class="badge bg-success">Response Received</span>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-comments me-2"></i>
                            No recent interactions recorded
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Industry and Location Distribution -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="mb-0 text-light">
                        <i class="fas fa-industry me-2"></i>Industry Distribution
                    </h6>
                </div>
                <div class="card-body">
                    {% for industry, count in industry_distribution %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-light">{{ industry or 'Unknown' }}</span>
                        <span class="badge bg-primary">{{ count }}</span>
                    </div>
                    {% else %}
                    <div class="text-center text-muted">
                        No industry data available
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="mb-0 text-light">
                        <i class="fas fa-map-marker-alt me-2"></i>Top Locations
                    </h6>
                </div>
                <div class="card-body">
                    {% for location, count in location_distribution %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-light">{{ location or 'Unknown' }}</span>
                        <span class="badge bg-success">{{ count }}</span>
                    </div>
                    {% else %}
                    <div class="text-center text-muted">
                        No location data available
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-robot me-2"></i>Stay-in-Touch Automation
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>Automation Type</th>
                                            <th>Frequency</th>
                                            <th>Active Alumni</th>
                                            <th>Engagement Rate</th>
                                            <th>Last Sent</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="automationTable">
                                        {% for automation in stay_in_touch_automations %}
                                        <tr>
                                            <td>
                                                <span class="badge bg-info">{{ automation.automation_type }}</span>
                                            </td>
                                            <td>{{ automation.frequency }}</td>
                                            <td>{{ automation.active_alumni_count }}</td>
                                            <td>
                                                <div class="progress bg-dark bg-opacity-50" style="height: 20px; width: 100px;">
                                                    <div class="progress-bar bg-success" style="width: {{ automation.engagement_rate }}%">
                                                        {{ "%.1f"|format(automation.engagement_rate) }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if automation.last_sent_date %}
                                                    {{ automation.last_sent_date.strftime('%Y-%m-%d') }}
                                                {% else %}
                                                    <span class="text-muted">Never</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="editAutomation('{{ automation.id }}')">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-success" onclick="testAutomation('{{ automation.id }}')">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                    <button class="btn btn-outline-warning" onclick="toggleAutomation('{{ automation.id }}')">
                                                        <i class="fas fa-power-off"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">No automation campaigns set up</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-dark bg-opacity-10 border-secondary">
                                <div class="card-body">
                                    <h6 class="text-light mb-3">Quick Actions</h6>
                                    
                                    <button class="btn btn-sm btn-outline-primary w-100 mb-2" id="createAutomation">
                                        <i class="fas fa-plus me-1"></i> Create Automation
                                    </button>
                                    
                                    <button class="btn btn-sm btn-outline-info w-100 mb-2" id="scheduleBirthdayCampaign">
                                        <i class="fas fa-birthday-cake me-1"></i> Schedule Birthday Campaign
                                    </button>
                                    
                                    <button class="btn btn-sm btn-outline-success w-100 mb-2" id="scheduleNewsletter">
                                        <i class="fas fa-newspaper me-1"></i> Schedule Newsletter
                                    </button>
                                    
                                    <button class="btn btn-sm btn-outline-warning w-100" id="viewAutomationStats">
                                        <i class="fas fa-chart-bar me-1"></i> View Statistics
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alumni Details Modal -->
<div class="modal fade" id="alumniDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>Alumni Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="alumniDetailsContent">
                    <!-- Alumni details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAlumniChanges">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Interaction Recording Modal -->
<div class="modal fade" id="interactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-phone me-2"></i>Record Interaction
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="interactionForm">
                    <div class="mb-3">
                        <label class="form-label">Interaction Type</label>
                        <select class="form-select" id="interactionType" required>
                            <option value="">Select type...</option>
                            <option value="email">Email</option>
                            <option value="phone">Phone Call</option>
                            <option value="linkedin">LinkedIn Message</option>
                            <option value="event">Event</option>
                            <option value="referral">Referral</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Purpose</label>
                        <select class="form-select" id="interactionPurpose">
                            <option value="">Select purpose...</option>
                            <option value="networking">Networking</option>
                            <option value="rehire_inquiry">Rehire Inquiry</option>
                            <option value="reference">Reference Check</option>
                            <option value="brand_ambassador">Brand Ambassador</option>
                            <option value="general">General Check-in</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="interactionDate" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="interactionNotes" rows="4" placeholder="Enter interaction details..."></textarea>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="responseReceived">
                        <label class="form-check-label" for="responseReceived">
                            Response Received
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="followUpRequired">
                        <label class="form-check-label" for="followUpRequired">
                            Follow-up Required
                        </label>
                    </div>
                    
                    <div class="mb-3" id="followUpDateDiv" style="display: none;">
                        <label class="form-label">Follow-up Date</label>
                        <input type="date" class="form-control" id="followUpDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveInteraction">Save Interaction</button>
            </div>
        </div>
    </div>
</div>

<style>
.progress-bar-striped {
    background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
    background-size: 1rem 1rem;
}

.avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 14px;
}

.badge {
    font-size: 0.75em;
}

.table-hover tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load real-time statistics
    loadAlumniStatistics();
    
    // Search alumni with debouncing
    let searchTimeout;
    document.getElementById('searchAlumni').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const searchTerm = this.value.toLowerCase();
        
        searchTimeout = setTimeout(() => {
            if (searchTerm.length >= 2 || searchTerm.length === 0) {
                searchAlumniFromDB(searchTerm);
            }
        }, 300);
    });
    
    // Filter alumni
    document.getElementById('statusFilter').addEventListener('change', filterAlumniFromDB);
    document.getElementById('industryFilter').addEventListener('change', filterAlumniFromDB);
    
    // Follow-up checkbox toggle
    document.getElementById('followUpRequired').addEventListener('change', function() {
        const followUpDateDiv = document.getElementById('followUpDateDiv');
        followUpDateDiv.style.display = this.checked ? 'block' : 'none';
    });
    
    // Set today's date as default for interaction date
    document.getElementById('interactionDate').valueAsDate = new Date();
});

// Load alumni statistics from database
function loadAlumniStatistics() {
    fetch('/api/alumni/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading statistics:', data.error);
                return;
            }
            
            // Update statistics cards with animation
            updateStatCard('totalAlumni', data.total_alumni);
            updateStatCard('activeAlumni', data.active_alumni);
            updateStatCard('rehirePotential', data.rehire_potential);
            updateStatCard('brandAmbassadors', data.brand_ambassadors);
        })
        .catch(error => {
            console.error('Error fetching statistics:', error);
        });
}

// Update statistics card with animation
function updateStatCard(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        const currentValue = parseInt(element.textContent) || 0;
        const targetValue = parseInt(value) || 0;
        
        // Animate number change
        if (currentValue !== targetValue) {
            animateValue(element, currentValue, targetValue, 500);
        }
    }
}

// Animate number changes
function animateValue(element, start, end, duration) {
    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            element.textContent = end;
            clearInterval(timer);
        } else {
            element.textContent = Math.round(current);
        }
    }, 16);
}

// Search alumni from database
function searchAlumniFromDB(query) {
    const statusFilter = document.getElementById('statusFilter').value;
    const industryFilter = document.getElementById('industryFilter').value;
    
    const params = new URLSearchParams({
        q: query,
        status: statusFilter,
        industry: industryFilter
    });
    
    fetch(`/api/alumni/search?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error searching alumni:', data.error);
                return;
            }
            
            updateAlumniTable(data.alumni);
        })
        .catch(error => {
            console.error('Error searching alumni:', error);
        });
}

// Filter alumni from database
function filterAlumniFromDB() {
    const searchTerm = document.getElementById('searchAlumni').value;
    searchAlumniFromDB(searchTerm);
}

// Update alumni table with search results
function updateAlumniTable(alumni) {
    const tbody = document.getElementById('alumniTable');
    
    if (alumni.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">No alumni found matching your criteria</td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = alumni.map(alumni_profile => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                        ${(alumni_profile.current_company || 'A')[0].toUpperCase()}
                    </div>
                    <div>
                        <strong>${alumni_profile.name}</strong>
                        ${alumni_profile.linkedin_url ? `
                        <a href="${alumni_profile.linkedin_url}" target="_blank" class="text-muted small ms-1">
                            <i class="fab fa-linkedin"></i>
                        </a>
                        ` : ''}
                    </div>
                </div>
            </td>
            <td>
                <span class="text-light">${alumni_profile.current_position || 'N/A'}</span>
                <br><small class="text-muted">${alumni_profile.current_company || 'N/A'}</small>
            </td>
            <td>
                <span class="badge bg-secondary">${alumni_profile.industry || 'Unknown'}</span>
            </td>
            <td>
                ${getStatusBadge(alumni_profile.alumni_status)}
            </td>
            <td>
                <span class="text-light">${alumni_profile.location || 'N/A'}</span>
                <br><small class="text-muted">Exited: ${alumni_profile.exit_date || 'N/A'}</small>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="viewAlumniDetails(${alumni_profile.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="editAlumni(${alumni_profile.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="recordInteraction(${alumni_profile.id})">
                        <i class="fas fa-phone"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Get status badge HTML
function getStatusBadge(status) {
    const statusConfig = {
        'active': { class: 'bg-success', text: 'Active' },
        'inactive': { class: 'bg-warning', text: 'Inactive' },
        'lost_contact': { class: 'bg-danger', text: 'Lost Contact' }
    };
    
    const config = statusConfig[status] || { class: 'bg-secondary', text: status };
    return `<span class="badge ${config.class}">${config.text}</span>`;
}

// View Alumni Details
function viewAlumniDetails(alumniId) {
    // Fetch alumni details from API
    fetch(`/api/alumni/${alumniId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error loading alumni details: ' + data.error);
                return;
            }
            
            // Update modal content
            document.getElementById('alumniDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-light mb-3">Personal Information</h6>
                        <p><strong>Name:</strong> ${data.name}</p>
                        <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${data.phone || 'N/A'}</p>
                        <p><strong>LinkedIn:</strong> ${data.linkedin_url ? `<a href="${data.linkedin_url}" target="_blank">Profile</a>` : 'N/A'}</p>
                        <p><strong>Location:</strong> ${data.location || 'N/A'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-light mb-3">Professional Information</h6>
                        <p><strong>Current Company:</strong> ${data.current_company || 'N/A'}</p>
                        <p><strong>Current Position:</strong> ${data.current_position || 'N/A'}</p>
                        <p><strong>Industry:</strong> ${data.industry || 'N/A'}</p>
                        <p><strong>Alumni Status:</strong> ${getStatusBadge(data.alumni_status)}</p>
                        <p><strong>Exit Date:</strong> ${data.exit_date}</p>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-light mb-3">Exit Information</h6>
                        <p><strong>Exit Reason:</strong> ${data.exit_reason || 'N/A'}</p>
                        <p><strong>Exit Feedback:</strong> ${data.exit_feedback || 'N/A'}</p>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-light mb-3">Notes</h6>
                        <p>${data.notes || 'No notes available'}</p>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-light mb-3">Recent Interactions</h6>
                        <div id="alumniInteractions">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading interactions...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load interaction history
            loadAlumniInteractions(alumniId);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('alumniDetailsModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load alumni details');
        });
}

// Load alumni interactions
function loadAlumniInteractions(alumniId) {
    fetch(`/api/alumni/${alumniId}/interactions`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('alumniInteractions').innerHTML = 
                    '<div class="text-center text-muted">Error loading interactions</div>';
                return;
            }
            
            const interactionsHtml = data.interactions.length > 0 ? 
                data.interactions.map(interaction => `
                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-dark bg-opacity-25 rounded">
                        <div>
                            <strong class="text-light">${interaction.interaction_type}</strong>
                            ${interaction.interaction_purpose ? `<span class="badge bg-info ms-2">${interaction.interaction_purpose}</span>` : ''}
                            <br><small class="text-muted">${interaction.interaction_date} by ${interaction.created_by}</small>
                            ${interaction.interaction_notes ? `<br><small class="text-muted">${interaction.interaction_notes.substring(0, 100)}${interaction.interaction_notes.length > 100 ? '...' : ''}</small>` : ''}
                        </div>
                        <div class="text-end">
                            ${interaction.response_received ? '<span class="badge bg-success">Response</span>' : '<span class="badge bg-secondary">No Response</span>'}
                            ${interaction.follow_up_required ? '<br><span class="badge bg-warning">Follow-up</span>' : ''}
                        </div>
                    </div>
                `).join('') :
                '<div class="text-center text-muted">No interactions recorded</div>';
            
            document.getElementById('alumniInteractions').innerHTML = interactionsHtml;
        })
        .catch(error => {
            console.error('Error loading interactions:', error);
            document.getElementById('alumniInteractions').innerHTML = 
                '<div class="text-center text-muted">Failed to load interactions</div>';
        });
}

// Edit Alumni
function editAlumni(alumniId) {
    viewAlumniDetails(alumniId);
    // Enable editing mode
    document.getElementById('saveAlumniChanges').style.display = 'block';
}

// Record Interaction
function recordInteraction(alumniId) {
    // Store alumni ID for later use
    document.getElementById('interactionModal').dataset.alumniId = alumniId;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('interactionModal'));
    modal.show();
}

// Save Interaction
document.getElementById('saveInteraction').addEventListener('click', function() {
    const alumniId = document.getElementById('interactionModal').dataset.alumniId;
    const formData = {
        alumni_id: alumniId,
        interaction_type: document.getElementById('interactionType').value,
        interaction_purpose: document.getElementById('interactionPurpose').value,
        interaction_date: document.getElementById('interactionDate').value,
        interaction_notes: document.getElementById('interactionNotes').value,
        response_received: document.getElementById('responseReceived').checked,
        follow_up_required: document.getElementById('followUpRequired').checked,
        follow_up_date: document.getElementById('followUpRequired').checked ? document.getElementById('followUpDate').value : null
    };
    
    // Submit interaction data
    fetch('/api/alumni/interaction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Interaction recorded successfully!');
            bootstrap.Modal.getInstance(document.getElementById('interactionModal')).hide();
            document.getElementById('interactionForm').reset();
            // Refresh statistics
            loadAlumniStatistics();
        } else {
            alert('Error recording interaction: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to record interaction');
    });
});

// Placeholder functions for other buttons
document.getElementById('exportAlumniData').addEventListener('click', function() {
    alert('Export functionality would be implemented here');
});

document.getElementById('bulkOutreach').addEventListener('click', function() {
    alert('Bulk outreach functionality would be implemented here');
});

document.getElementById('addAlumni').addEventListener('click', function() {
    alert('Add alumni functionality would be implemented here');
});

document.getElementById('viewAllRehire').addEventListener('click', function() {
    alert('View all rehire candidates functionality would be implemented here');
});

document.getElementById('manageAmbassadors').addEventListener('click', function() {
    alert('Manage brand ambassadors functionality would be implemented here');
});

document.getElementById('createAutomation').addEventListener('click', function() {
    alert('Create automation functionality would be implemented here');
});

document.getElementById('scheduleBirthdayCampaign').addEventListener('click', function() {
    alert('Schedule birthday campaign functionality would be implemented here');
});

document.getElementById('scheduleNewsletter').addEventListener('click', function() {
    alert('Schedule newsletter functionality would be implemented here');
});

document.getElementById('viewAutomationStats').addEventListener('click', function() {
    alert('View automation statistics functionality would be implemented here');
});

function editAutomation(id) {
    alert('Edit automation functionality would be implemented here');
}

function testAutomation(id) {
    alert('Test automation functionality would be implemented here');
}

function toggleAutomation(id) {
    alert('Toggle automation functionality would be implemented here');
}
</script>
{% endblock %}
