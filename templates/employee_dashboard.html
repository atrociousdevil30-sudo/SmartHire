{% extends "employee_base.html" %}

{% block title %}Employee Dashboard{% endblock %}

{% block page_content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-light">
                        <i class="bi bi-person-circle me-2"></i>Welcome, {{ user.full_name or user.username }}!
                    </h1>
                    <p class="text-muted mb-0">Your employee dashboard and quick actions</p>
                </div>
                <div class="d-flex">
                    <span class="me-2">
                        <span class="badge bg-primary bg-opacity-25 text-primary">{{ user.role or 'Employee' }}</span>
                    </span>
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#helpModal">
                        <i class="bi bi-question-circle me-1"></i> Help
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary d-flex justify-content-between align-items-center">
                    <h6 class="text-light mb-0">Onboarding Progress</h6>
                    <span class="text-primary">Day {{ employee['onboarding_progress']['current_day'] }} of {{ employee['onboarding_progress']['total_days'] }}</span>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" 
                             data-progress="{{ onboarding_progress }}" aria-valuenow="{{ onboarding_progress }}" aria-valuemin="0" aria-valuemax="100">{{ onboarding_progress }}%</div>
                    </div>
                    <div class="text-center small">
                        <span class="me-3"><i class="bi bi-check-circle text-success me-1"></i> Account Setup</span>
                        <span class="me-3"><i class="bi bi-{% if onboarding_progress >= 40 %}check-circle text-success{% else %}clock text-warning{% endif %} me-1"></i> Documentation</span>
                        <span class="me-3"><i class="bi bi-{% if onboarding_progress >= 60 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> Training</span>
                        <span class="me-3"><i class="bi bi-{% if onboarding_progress >= 80 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> Equipment</span>
                        <span class="me-3"><i class="bi bi-{% if onboarding_progress >= 100 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> Final Review</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <!-- Tab Navigation -->
                <div class="card-header bg-transparent border-secondary">
                    <ul class="nav nav-tabs card-header-tabs" id="dashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                                <i class="bi bi-list-task me-1"></i> Pending Tasks
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="journey-tab" data-bs-toggle="tab" data-bs-target="#journey" type="button" role="tab">
                                <i class="bi bi-signpost-2 me-1"></i> My Journey
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button" role="tab">
                                <i class="bi bi-book me-1"></i> Resources
                            </button>
                        </li>
                    </ul>
                </div>
                
                <!-- Tab Content -->
                <div class="card-body">
                    <div class="tab-content" id="dashboardTabsContent">
                        <!-- Pending Tasks Tab -->
                        <div class="tab-pane fade show active" id="tasks" role="tabpanel">
                            <div class="list-group">
                                {% for task in employee['pending_tasks'] %}
                                <a href="{{ url_for('onboarding_tasks') }}" class="list-group-item list-group-item-action bg-dark bg-opacity-25 border-secondary">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1 text-light">{{ task['title'] }}</h6>
                                        <small class="{% if task['priority'] == 'high' %}text-danger{% elif task['priority'] == 'medium' %}text-warning{% else %}text-info{% endif %}">{{ task['due'] }}</small>
                                    </div>
                                    <p class="mb-1 text-muted">{% if task['title'] == 'Submit timesheet' %}Complete your weekly timesheet in the employee portal.{% elif task['title'] == 'Complete training module' %}Mandatory training module for new employees.{% else %}Update project documentation as assigned.{% endif %}</p>
                                    <small class="text-muted">{% if task['priority'] == 'high' %}HR Department{% elif task['priority'] == 'medium' %}IT Department{% else %}Operations{% endif %}</small>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Employee Journey Tab -->
                        <div class="tab-pane fade" id="journey" role="tabpanel">
                            <div class="timeline-vertical">
                                <!-- Journey Items -->
                                {% for step_name, step_data in employee_journey.items() %}
                                <div class="timeline-item-vertical {% if step_data.completed %}completed{% endif %}">
                                    <div class="timeline-marker-vertical {% if step_data.completed %}bg-success{% else %}bg-warning{% endif %}">
                                        <i class="bi bi-{% if step_data.completed %}check{% else %}clock{% endif %}"></i>
                                    </div>
                                    <div class="timeline-content-vertical">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1 text-light">{{ step_name.replace('_', ' ').title() }}</h6>
                                                <p class="mb-1 small text-muted">{{ step_data.date or 'Pending' }}</p>
                                                <p class="mb-1 small text-muted">{{ step_data.description or 'Step in your journey' }}</p>
                                            </div>
                                            {% if step_data.completed %}
                                            <span class="badge bg-success">Completed</span>
                                            {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Resources Tab -->
                        <div class="tab-pane fade" id="resources" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-light mb-3">HR Contact</h6>
                                    <div class="card bg-dark bg-opacity-50 border-secondary mb-3">
                                        <div class="card-body text-center">
                                            <div class="avatar-sm bg-primary bg-opacity-10 text-primary rounded-circle mx-auto mb-2" style="width: 60px; height: 60px; line-height: 60px;">
                                                <i class="bi bi-person"></i>
                                            </div>
                                            <h6 class="text-light">{{ hr_contact.full_name if hr_contact else 'HR Department' }}</h6>
                                            <p class="text-muted small">{{ hr_contact.position if hr_contact and hr_contact.position else 'HR Business Partner' }}</p>
                                            <p class="mb-2">
                                                <a href="mailto:{{ hr_contact.email if hr_contact else 'hr@company.com' }}" class="text-primary">
                                                    <i class="bi bi-envelope me-1"></i>{{ hr_contact.email if hr_contact else 'hr@company.com' }}
                                                </a>
                                            </p>
                                            <button class="btn btn-outline-primary btn-sm me-2" onclick="messageHR()">
                                                <i class="bi bi-envelope me-1"></i> Message
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-light mb-3">Company Resources</h6>
                                    <div class="list-group">
                                        <a href="#" class="list-group-item list-group-item-action bg-dark bg-opacity-25 border-secondary">
                                            <i class="bi bi-file-pdf me-2 text-danger"></i> Employee Handbook
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action bg-dark bg-opacity-25 border-secondary">
                                            <i class="bi bi-shield-check me-2 text-success"></i> IT Security Policy
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action bg-dark bg-opacity-25 border-secondary">
                                            <i class="bi bi-heart me-2 text-info"></i> Health & Wellness
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action bg-dark bg-opacity-25 border-secondary">
                                            <i class="bi bi-building me-2 text-warning"></i> Office Map
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action bg-dark bg-opacity-25 border-secondary">
                                            <i class="bi bi-headset me-2 text-primary"></i> IT Support
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mood Feedback -->
    <div class="row mt-4">
        <div class="col-12">
            {% include 'includes/mood_feedback.html' %}
        </div>
    </div>
</div>

<style>
/* Vertical Timeline Styles - Dark Theme */
.timeline-vertical {
    position: relative;
    padding-left: 40px;
}

.timeline-vertical::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #7b2cbf, #5a189a);
}

.timeline-item-vertical {
    position: relative;
    margin-bottom: 30px;
}

.timeline-item-vertical:last-child {
    margin-bottom: 0;
}

.timeline-marker-vertical {
    position: absolute;
    left: -25px;
    top: 5px;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    border: 2px solid #1a1a1a;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    z-index: 1;
}

.timeline-content-vertical {
    background: rgba(26, 26, 26, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #7b2cbf;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.timeline-content-vertical:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transform: translateY(-2px);
    border-color: #9d4edd;
}

.timeline-content-vertical h6 {
    color: #f8f9fa !important;
}

.timeline-content-vertical p {
    color: #adb5bd !important;
}

.timeline-item-vertical.completed .timeline-content-vertical {
    border-left-color: #1cc88a;
    background: rgba(28, 200, 138, 0.1);
}

.timeline-item-vertical.completed .timeline-marker-vertical {
    background: #1cc88a !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .timeline-vertical {
        padding-left: 30px;
    }
    
    .timeline-marker-vertical {
        left: -20px;
        width: 25px;
        height: 25px;
        font-size: 10px;
    }
    
    .timeline-content-vertical {
        padding: 12px;
    }
}
</style>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="helpModalLabel">Need Help?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>If you need assistance with your onboarding process, please contact:</p>
                <ul class="list-unstyled">
                    <li><i class="fas fa-envelope me-2"></i>{{ hr_contact.email if hr_contact else 'hr@company.com' }}</li>
                    <li><i class="fas fa-phone me-2"></i>{{ hr_contact.phone if hr_contact else 'Not available' }}</li>
                </ul>
                <p class="mb-0">Our HR team is available Monday-Friday, 9:00 AM - 5:00 PM EST.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="sendWhatsAppMessage()">
                    <i class="fab fa-whatsapp me-1"></i> Send Message
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
// Profile Modal Functions
function loadProfileModal() {
    fetch('/api/employee/profile', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('fullName').value = data.data.full_name;
            document.getElementById('email').value = data.data.email;
            document.getElementById('phone').value = data.data.phone;
            document.getElementById('department').value = data.data.department;
            document.getElementById('position').value = data.data.position;
        }
    })
    .catch(error => console.error('Error:', error));
}

function saveProfile() {
    const formData = new FormData();
    formData.append('phone', document.getElementById('phone').value);
    formData.append('department', document.getElementById('department').value);
    formData.append('position', document.getElementById('position').value);
    
    fetch('/api/employee/profile', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Profile updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save profile');
    });
}

// Documents Modal Functions
function loadDocumentsModal() {
    fetch('/api/employee/documents', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const documentsList = document.getElementById('documentsList');
            if (data.data.length === 0) {
                documentsList.innerHTML = '<p class="text-muted">No documents uploaded yet.</p>';
            } else {
                let html = '<div class="list-group">';
                data.data.forEach(doc => {
                    html += `<div class="list-group-item"><strong>${doc.file_name}</strong> (${doc.document_type})</div>`;
                });
                html += '</div>';
                documentsList.innerHTML = html;
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

// Settings Modal Functions
function loadSettingsModal() {
    fetch('/api/employee/settings', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('emailNotifications').checked = data.data.email_notifications;
            document.getElementById('smsNotifications').checked = data.data.sms_notifications;
            document.getElementById('notificationFrequency').value = data.data.notification_frequency;
            document.getElementById('theme').value = data.data.theme;
            document.getElementById('language').value = data.data.language;
            document.getElementById('twoFactorAuth').checked = data.data.two_factor_enabled;
        }
    })
    .catch(error => console.error('Error:', error));
}

function saveSettings() {
    const formData = new FormData();
    formData.append('email_notifications', document.getElementById('emailNotifications').checked);
    formData.append('sms_notifications', document.getElementById('smsNotifications').checked);
    formData.append('notification_frequency', document.getElementById('notificationFrequency').value);
    formData.append('theme', document.getElementById('theme').value);
    formData.append('language', document.getElementById('language').value);
    formData.append('two_factor_enabled', document.getElementById('twoFactorAuth').checked);
    
    fetch('/api/employee/settings', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Settings updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save settings');
    });
}

function messageHR() {
    // Get HR email from the template
    const hrEmail = '{{ hr_contact.email if hr_contact else "hr@company.com" }}';
    const subject = encodeURIComponent('Employee Dashboard Inquiry');
    const body = encodeURIComponent('Hi,\n\nI have a question regarding my onboarding/employment.\n\nThank you.');
    
    // Open Gmail compose in new tab
    window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${hrEmail}&su=${subject}&body=${body}`, '_blank');
}

function sendWhatsAppMessage() {
    // Get HR phone from the template exactly as shown
    let hrPhone = '{{ hr_contact.phone if hr_contact else "+1 (555) 123-4567" }}';
    
    // Remove all non-digit characters for WhatsApp URL
    hrPhone = hrPhone.replace(/\D/g, '');
    
    // Predefined message
    const message = encodeURIComponent('Hi, I need assistance with my onboarding process. Could you please help me?');
    
    // Open WhatsApp with the HR contact's phone number
    window.open(`https://wa.me/${hrPhone}?text=${message}`, '_blank');
}

// Set progress bar widths from data attributes
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('[data-progress]');
    progressBars.forEach(bar => {
        const progress = bar.getAttribute('data-progress');
        if (progress) {
            bar.style.width = progress + '%';
        }
    });
});
</script>
{% endblock %}
