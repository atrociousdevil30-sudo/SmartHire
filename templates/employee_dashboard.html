{% extends "employee_base.html" %}

{% block title %}Employee Dashboard{% endblock %}

{% block page_content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-light">
                        <i class="bi bi-person-circle me-2"></i>Welcome, {{ user.full_name or user.username }}!
                    </h1>
                    <p class="text-muted mb-0">Your employee dashboard and quick actions</p>
                </div>
                <div class="d-flex">
                    <span class="me-2">
                        <span class="badge bg-primary bg-opacity-25 text-primary">{{ user.role or 'Employee' }}</span>
                    </span>
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#helpModal">
                        <i class="bi bi-question-circle me-1"></i> Help
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="row mb-4">
        <div class="col-12">
            {% if employee.status == 'Onboarding' %}
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary d-flex justify-content-between align-items-center">
                    <h6 class="text-light mb-0">Onboarding Progress</h6>
                    <span class="text-primary">Day {{ employee['onboarding_progress']['current_day'] }} of {{ employee['onboarding_progress']['total_days'] }}</span>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" 
                             data-progress="{{ employee['onboarding_progress']['percentage'] }}" aria-valuenow="{{ employee['onboarding_progress']['percentage'] }}" aria-valuemin="0" aria-valuemax="100">{{ employee['onboarding_progress']['percentage'] }}%</div>
                    </div>
                    <div class="text-center small">
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 8 %}check-circle text-success{% else %}clock text-warning{% endif %} me-1"></i> Employment Paperwork</span>
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 17 %}check-circle text-success{% else %}clock text-warning{% endif %} me-1"></i> Document Collection</span>
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 25 %}check-circle text-success{% else %}clock text-warning{% endif %} me-1"></i> Welcome Email & Handbook</span>
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 33 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> ID Card Creation</span>
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 42 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> Email Account Setup</span>
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 50 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> Development Environment</span>
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 58 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> Code Repository Access</span>
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 67 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> Technical Orientation</span>
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 75 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> Laptop & Equipment</span>
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 83 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> Team Introduction</span>
                        <span class="me-3"><i class="bi bi-{% if employee['onboarding_progress']['percentage'] >= 92 %}check-circle text-success{% else %}clock text-muted{% endif %} me-1"></i> First Week Check-in</span>
                    </div>
                </div>
            </div>
            {% elif employee.status == 'Offboarding' %}
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary d-flex justify-content-between align-items-center">
                    <h6 class="text-light mb-0">Offboarding Progress</h6>
                    <span class="text-warning">Day {{ employee['offboarding_progress']['current_day'] }} of {{ employee['offboarding_progress']['total_days'] }}</span>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" 
                             data-progress="{{ employee['offboarding_progress']['percentage'] }}" aria-valuenow="{{ employee['offboarding_progress']['percentage'] }}" aria-valuemin="0" aria-valuemax="100">{{ employee['offboarding_progress']['percentage'] }}%</div>
                    </div>
                    <div class="text-center small">
                        <span class="me-3"><i class="bi bi-{% if employee['offboarding_progress']['percentage'] >= 20 %}check-circle text-success{% else %}clock text-warning{% endif %} me-1"></i> Handover Responsibilities</span>
                        <span class="me-3"><i class="bi bi-{% if employee['offboarding_progress']['percentage'] >= 40 %}check-circle text-success{% else %}clock text-warning{% endif %} me-1"></i> Return Company Assets</span>
                        <span class="me-3"><i class="bi bi-{% if employee['offboarding_progress']['percentage'] >= 60 %}check-circle text-success{% else %}clock text-warning{% endif %} me-1"></i> Exit Interview</span>
                        <span class="me-3"><i class="bi bi-{% if employee['offboarding_progress']['percentage'] >= 80 %}check-circle text-success{% else %}clock text-warning{% endif %} me-1"></i> Final Documentation</span>
                        <span class="me-3"><i class="bi bi-{% if employee['offboarding_progress']['percentage'] >= 100 %}check-circle text-success{% else %}clock text-warning{% endif %} me-1"></i> Account Closure</span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <div class="card-header bg-transparent border-secondary">
                    <h6 class="text-light mb-0">Welcome to Your Dashboard</h6>
                </div>
                <div class="card-body text-center">
                    <p class="text-muted mb-0">You are an active employee. No onboarding or offboarding tasks are currently assigned.</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark bg-opacity-25 border-secondary">
                <!-- Tab Navigation -->
                <div class="card-header bg-transparent border-secondary">
                    <ul class="nav nav-tabs card-header-tabs" id="dashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                                <i class="bi bi-list-task me-1"></i> Pending Tasks
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="journey-tab" data-bs-toggle="tab" data-bs-target="#journey" type="button" role="tab">
                                <i class="bi bi-signpost-2 me-1"></i> My Journey
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button" role="tab">
                                <i class="bi bi-book me-1"></i> Resources
                            </button>
                        </li>
                    </ul>
                </div>
                
                <!-- Tab Content -->
                <div class="card-body">
                    <div class="tab-content" id="dashboardTabsContent">
                        <!-- Pending Tasks Tab -->
                        <div class="tab-pane fade show active" id="tasks" role="tabpanel">
                            {% if employee_tasks %}
                            <div class="list-group">
                                {% for task in employee_tasks %}
                                <div class="list-group-item bg-dark bg-opacity-25 border-secondary">
                                    <div class="d-flex w-100 justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-2">
                                                <h6 class="mb-0 me-2 text-light">{{ task.title }}</h6>
                                                <span class="badge bg-{{ 'danger' if task.priority == 'high' else 'warning' if task.priority == 'medium' else 'success' }} me-2">
                                                    {{ task.priority.title() }}
                                                </span>
                                                <span class="badge bg-{{ 'success' if task.status == 'completed' else 'primary' if task.status == 'in_progress' else 'secondary' }}">
                                                    {{ task.status.replace('_', ' ').title() }}
                                                </span>
                                            </div>
                                            {% if task.description %}
                                            <p class="mb-2 text-muted small">{{ task.description[:100] }}{% if task.description|length > 100 %}...{% endif %}</p>
                                            {% endif %}
                                            <div class="d-flex align-items-center">
                                                {% if task.due_date %}
                                                <small class="{% if task.is_overdue %}text-danger{% else %}text-info{% endif %} me-3">
                                                    <i class="bi bi-calendar me-1"></i>{{ task.due_date.strftime('%Y-%m-%d') }}
                                                    {% if task.is_overdue %}<span class="ms-1">(Overdue)</span>{% endif %}
                                                </small>
                                                {% endif %}
                                                <small class="text-muted">
                                                    <i class="bi bi-tag me-1"></i>{{ task.task_type.title() }}
                                                </small>
                                            </div>
                                        </div>
                                        {% if task.status != 'completed' %}
                                        <div class="btn-group btn-group-sm ms-2" role="group">
                                            <button type="button" class="btn btn-outline-success" 
                                                    data-task-id="{{ task.id }}" 
                                                    data-status="completed" 
                                                    onclick="updateTaskStatus(this)" 
                                                    title="Mark as Complete">
                                                <i class="bi bi-check"></i>
                                            </button>
                                            {% if task.status == 'pending' %}
                                            <button type="button" class="btn btn-outline-primary" 
                                                    data-task-id="{{ task.id }}" 
                                                    data-status="in_progress" 
                                                    onclick="updateTaskStatus(this)" 
                                                    title="Start Task">
                                                <i class="bi bi-play"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-check-circle fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No tasks assigned</h6>
                                <p class="text-muted small">You don't have any tasks assigned to you right now.</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Employee Journey Tab -->
                        <div class="tab-pane fade" id="journey" role="tabpanel">
                            <div class="timeline-vertical">
                                <!-- Journey Items -->
                                {% for step_name, step_data in employee_journey.items() %}
                                <div class="timeline-item-vertical {% if step_data.completed %}completed{% endif %}">
                                    <div class="timeline-marker-vertical {% if step_data.completed %}bg-success{% else %}bg-warning{% endif %}">
                                        <i class="bi bi-{% if step_data.completed %}check{% else %}clock{% endif %}"></i>
                                    </div>
                                    <div class="timeline-content-vertical">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1 text-light">{{ step_name.replace('_', ' ').title() }}</h6>
                                                <p class="mb-1 small text-muted">{{ step_data.date or 'Pending' }}</p>
                                                <p class="mb-1 small text-muted">{{ step_data.description or 'Step in your journey' }}</p>
                                            </div>
                                            {% if step_data.completed %}
                                            <span class="badge bg-success">Completed</span>
                                            {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Resources Tab -->
                        <div class="tab-pane fade" id="resources" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-light mb-3">HR Contact</h6>
                                    <div class="card bg-dark bg-opacity-50 border-secondary mb-3">
                                        <div class="card-body text-center">
                                            <div class="avatar-sm bg-primary bg-opacity-10 text-primary rounded-circle mx-auto mb-2" style="width: 60px; height: 60px; line-height: 60px;">
                                                <i class="bi bi-person"></i>
                                            </div>
                                            <h6 class="text-light">{{ hr_contact.full_name if hr_contact else 'HR Department' }}</h6>
                                            <p class="text-muted small">{{ hr_contact.position if hr_contact and hr_contact.position else 'HR Business Partner' }}</p>
                                            <p class="mb-2">
                                                <a href="mailto:{{ hr_contact.email if hr_contact else 'hr@company.com' }}" class="text-primary">
                                                    <i class="bi bi-envelope me-1"></i>{{ hr_contact.email if hr_contact else 'hr@company.com' }}
                                                </a>
                                            </p>
                                            <button class="btn btn-outline-primary btn-sm me-2" onclick="messageHR()">
                                                <i class="bi bi-envelope me-1"></i> Message
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-light mb-3">Buddy/Mentor</h6>
                                    {% if buddy_mentor %}
                                    <div class="card bg-dark bg-opacity-50 border-secondary mb-3">
                                        <div class="card-body text-center">
                                            <div class="avatar-sm bg-success bg-opacity-10 text-success rounded-circle mx-auto mb-2" style="width: 60px; height: 60px; line-height: 60px;">
                                                <i class="bi bi-people"></i>
                                            </div>
                                            {% set buddy_user = buddy_mentor.mentor if buddy_mentor.mentee_id == user.id else buddy_mentor.mentee %}
                                            <h6 class="text-light">{{ buddy_user.full_name or buddy_user.username }}</h6>
                                            <p class="text-muted small">{{ buddy_mentor.relationship_type.title() }}</p>
                                            {% if buddy_mentor.program_name %}
                                            <p class="text-muted small">{{ buddy_mentor.program_name }}</p>
                                            {% endif %}
                                            <p class="mb-2">
                                                <a href="mailto:{{ buddy_user.email }}" class="text-success">
                                                    <i class="bi bi-envelope me-1"></i>{{ buddy_user.email }}
                                                </a>
                                            </p>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-success" onclick="messageBuddy()">
                                                    <i class="bi bi-envelope me-1"></i> Message
                                                </button>
                                                <button class="btn btn-outline-info" onclick="scheduleMeeting()">
                                                    <i class="bi bi-calendar me-1"></i> Meet
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="card bg-dark bg-opacity-50 border-secondary mb-3">
                                        <div class="card-body text-center">
                                            <div class="avatar-sm bg-secondary bg-opacity-10 text-secondary rounded-circle mx-auto mb-2" style="width: 60px; height: 60px; line-height: 60px;">
                                                <i class="bi bi-people"></i>
                                            </div>
                                            <h6 class="text-light">No Buddy/Mentor Assigned</h6>
                                            <p class="text-muted small">A buddy or mentor will be assigned to you soon.</p>
                                            <button class="btn btn-outline-secondary btn-sm" disabled>
                                                <i class="bi bi-clock me-1"></i> Pending Assignment
                                            </button>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-light mb-3">HR Contact Information</h6>
                                    <div class="list-group">
                                        {% if hr_contacts %}
                                            {% for hr_contact in hr_contacts[:3] %}
                                                <div class="list-group-item bg-dark bg-opacity-25 border-secondary">
                                                    <div class="d-flex align-items-center">
                                                        <div class="avatar-sm me-3">
                                                            <div class="avatar-title bg-primary bg-opacity-10 text-primary rounded-circle" style="width: 32px; height: 32px; line-height: 32px;">
                                                                {{ hr_contact.full_name|first|upper }}
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <h6 class="text-light mb-0">{{ hr_contact.full_name }}</h6>
                                                            <small class="text-muted">{{ hr_contact.position or 'HR Representative' }}</small>
                                                        </div>
                                                        <div class="text-end">
                                                            <a href="tel:{{ hr_contact.phone }}" class="btn btn-outline-primary btn-sm me-1" title="Call">
                                                                <i class="fas fa-phone"></i>
                                                            </a>
                                                            <a href="https://wa.me/{{ hr_contact.phone.replace(' ', '').replace('-', '').replace('(', '').replace(')', '') }}" class="btn btn-outline-success btn-sm" target="_blank" title="WhatsApp">
                                                                <i class="fab fa-whatsapp"></i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="list-group-item bg-dark bg-opacity-25 border-secondary text-center">
                                                <i class="fas fa-users fa-2x text-muted mb-2"></i>
                                                <p class="text-muted mb-0">HR Team information will be available soon</p>
                                            </div>
                                        {% endif %}
                                        
                                        {% if hr_contact %}
                                            <div class="list-group-item bg-dark bg-opacity-25 border-secondary">
                                                <div class="text-center">
                                                    <small class="text-muted">Primary HR Contact</small>
                                                    <div class="text-light mt-1">
                                                        <i class="fas fa-envelope me-2"></i>{{ hr_contact.email }}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mood Feedback -->
    <div class="row mt-4">
        <div class="col-12">
            {% include 'includes/mood_feedback.html' %}
        </div>
    </div>
</div>

<style>
/* Vertical Timeline Styles - Dark Theme */
.timeline-vertical {
    position: relative;
    padding-left: 40px;
}

.timeline-vertical::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #7b2cbf, #5a189a);
}

.timeline-item-vertical {
    position: relative;
    margin-bottom: 30px;
}

.timeline-item-vertical:last-child {
    margin-bottom: 0;
}

.timeline-marker-vertical {
    position: absolute;
    left: -25px;
    top: 5px;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    border: 2px solid #1a1a1a;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    z-index: 1;
}

.timeline-content-vertical {
    background: rgba(26, 26, 26, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #7b2cbf;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.timeline-content-vertical:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transform: translateY(-2px);
    border-color: #9d4edd;
}

.timeline-content-vertical h6 {
    color: #f8f9fa !important;
}

.timeline-content-vertical p {
    color: #adb5bd !important;
}

.timeline-item-vertical.completed .timeline-content-vertical {
    border-left-color: #1cc88a;
    background: rgba(28, 200, 138, 0.1);
}

.timeline-item-vertical.completed .timeline-marker-vertical {
    background: #1cc88a !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .timeline-vertical {
        padding-left: 30px;
    }
    
    .timeline-marker-vertical {
        left: -20px;
        width: 25px;
        height: 25px;
        font-size: 10px;
    }
    
    .timeline-content-vertical {
        padding: 12px;
    }
}
</style>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="helpModalLabel">Need Help?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>If you need assistance with your onboarding process, please contact:</p>
                <ul class="list-unstyled">
                    <li><i class="fas fa-envelope me-2"></i>{{ hr_contact.email if hr_contact else 'hr@company.com' }}</li>
                    <li><i class="fas fa-phone me-2"></i>{{ hr_contact.phone if hr_contact else 'Not available' }}</li>
                </ul>
                <p class="mb-0">Our HR team is available Monday-Friday, 9:00 AM - 5:00 PM EST.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="sendWhatsAppMessage()">
                    <i class="fab fa-whatsapp me-1"></i> Send Message
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
// Profile Modal Functions
function loadProfileModal() {
    fetch('/api/employee/profile', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('fullName').value = data.data.full_name;
            document.getElementById('email').value = data.data.email;
            document.getElementById('phone').value = data.data.phone;
            document.getElementById('department').value = data.data.department;
            document.getElementById('position').value = data.data.position;
        }
    })
    .catch(error => console.error('Error:', error));
}

function saveProfile() {
    const formData = new FormData();
    formData.append('phone', document.getElementById('phone').value);
    formData.append('department', document.getElementById('department').value);
    formData.append('position', document.getElementById('position').value);
    
    fetch('/api/employee/profile', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Profile updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save profile');
    });
}

// Documents Modal Functions
function loadDocumentsModal() {
    fetch('/api/employee/documents', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const documentsList = document.getElementById('documentsList');
            if (data.data.length === 0) {
                documentsList.innerHTML = '<p class="text-muted">No documents uploaded yet.</p>';
            } else {
                let html = '<div class="list-group">';
                data.data.forEach(doc => {
                    html += `<div class="list-group-item"><strong>${doc.file_name}</strong> (${doc.document_type})</div>`;
                });
                html += '</div>';
                documentsList.innerHTML = html;
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

// Settings Modal Functions
function loadSettingsModal() {
    fetch('/api/employee/settings', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('emailNotifications').checked = data.data.email_notifications;
            document.getElementById('smsNotifications').checked = data.data.sms_notifications;
            document.getElementById('notificationFrequency').value = data.data.notification_frequency;
            document.getElementById('theme').value = data.data.theme;
            document.getElementById('language').value = data.data.language;
            document.getElementById('twoFactorAuth').checked = data.data.two_factor_enabled;
        }
    })
    .catch(error => console.error('Error:', error));
}

function saveSettings() {
    const formData = new FormData();
    formData.append('email_notifications', document.getElementById('emailNotifications').checked);
    formData.append('sms_notifications', document.getElementById('smsNotifications').checked);
    formData.append('notification_frequency', document.getElementById('notificationFrequency').value);
    formData.append('theme', document.getElementById('theme').value);
    formData.append('language', document.getElementById('language').value);
    formData.append('two_factor_enabled', document.getElementById('twoFactorAuth').checked);
    
    fetch('/api/employee/settings', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Settings updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save settings');
    });
}

function messageHR() {
    // Get HR email from the template
    const hrEmail = '{{ hr_contact.email if hr_contact else "hr@company.com" }}';
    const subject = encodeURIComponent('Employee Dashboard Inquiry');
    const body = encodeURIComponent('Hi,\n\nI have a question regarding my onboarding/employment.\n\nThank you.');
    
    // Open Gmail compose in new tab
    window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${hrEmail}&su=${subject}&body=${body}`, '_blank');
}

function updateTaskStatus(button) {
    const taskId = button.dataset.taskId;
    const newStatus = button.dataset.status;
    
    fetch(`/api/employee/tasks/${taskId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Reload the page to show updated status
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update task status');
    });
}

function messageBuddy() {
    // Get buddy email from the template
    const buddyEmail = '{{ buddy_user.email if buddy_mentor else "" }}';
    const subject = encodeURIComponent('Check-in / Question');
    const body = encodeURIComponent('Hi,\n\nI wanted to connect and check in. I have a few questions I\'d love to discuss when you have time.\n\nThanks!');
    
    // Open Gmail compose in new tab
    window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${buddyEmail}&su=${subject}&body=${body}`, '_blank');
}

function scheduleMeeting() {
    // Get buddy email for calendar invite
    const buddyEmail = '{{ buddy_user.email if buddy_mentor else "" }}';
    const subject = encodeURIComponent('Buddy/Mentor Check-in Meeting');
    const body = encodeURIComponent('Let\'s schedule a check-in meeting to discuss progress and any questions.');
    
    // Open Google Calendar to create event
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + 1); // Tomorrow
    const dateStr = startDate.toISOString().split('T')[0];
    
    window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${subject}&details=${body}&add=${buddyEmail}&dates=${dateStr}T100000/${dateStr}T110000`, '_blank');
}

function sendWhatsAppMessage() {
    // Get HR phone from the template exactly as shown
    let hrPhone = '{{ hr_contact.phone if hr_contact else "+1 (555) 123-4567" }}';
    
    // Remove all non-digit characters for WhatsApp URL
    hrPhone = hrPhone.replace(/\D/g, '');
    
    // Predefined message
    const message = encodeURIComponent('Hi, I need assistance with my onboarding process. Could you please help me?');
    
    // Open WhatsApp with the HR contact's phone number
    window.open(`https://wa.me/${hrPhone}?text=${message}`, '_blank');
}

// Set progress bar widths from data attributes
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('[data-progress]');
    progressBars.forEach(bar => {
        const progress = bar.getAttribute('data-progress');
        if (progress) {
            bar.style.width = progress + '%';
        }
    });
});
</script>
{% endblock %}
