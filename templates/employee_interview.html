{% extends "employee_base.html" %}

{% block title %}AI Interview Session - SmartHire{% endblock %}

{% block page_content %}
<div class="container-fluid py-4">
    <!-- Interview Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-microphone me-2"></i>AI Interview Session
                    </h1>
                    <p class="text-muted mb-0" id="interviewStatus">Ready to start interview</p>
                </div>
                <div>
                    <span class="badge bg-primary me-2" id="timerBadge" style="display:none;">00:00</span>
                    <button class="btn btn-outline-danger" id="exitBtn" onclick="confirmExit()" style="display:none;">
                        <i class="fas fa-times me-1"></i>Exit Interview
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Interview Info -->
        <div class="col-lg-3 mb-4">
            <!-- Interview Details Card -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Interview Details</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted d-block">Position</small>
                        <strong id="positionName">Loading...</strong>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Interview Type</small>
                        <strong id="interviewType">Loading...</strong>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Difficulty Level</small>
                        <strong id="difficultyLevel">Loading...</strong>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Total Questions</small>
                        <strong id="totalQuestions">5</strong>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Duration</small>
                        <strong id="duration">30 minutes</strong>
                    </div>
                </div>
            </div>

            <!-- HR Instructions Card -->
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-clipboard me-2"></i>HR Guidelines</h6>
                </div>
                <div class="card-body">
                    <div id="hrInstructions" class="small">
                        <p class="text-muted">Loading HR instructions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Interview Area -->
        <div class="col-lg-9">
            <!-- Waiting for HR Container -->
            <div id="waitingContainer" class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-hourglass-start text-primary mb-3" style="font-size: 3rem;"></i>
                    <h4 class="mb-3">Ready to Start Interview?</h4>
                    <p class="text-muted mb-4">Send a message to HR confirming you are ready. HR will start the interview and send you a join link.</p>
                    
                    <div class="mb-4">
                        <textarea class="form-control mb-3" id="readyMessage" rows="3" placeholder="Optional message to HR (e.g., 'I am ready for the interview')"></textarea>
                        <button class="btn btn-primary btn-lg" onclick="sendReadyMessage()">
                            <i class="fas fa-paper-plane me-2"></i>I'm Ready - Notify HR
                        </button>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Once you send this message, HR will be notified and will start your interview session.
                    </div>
                </div>
            </div>

            <!-- Waiting for HR Response Container -->
            <div id="waitingForHRContainer" class="card shadow d-none">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h4 class="mb-3">Waiting for HR to Start Interview</h4>
                    <p class="text-muted mb-4">Your message has been sent to HR. Please wait for them to start your interview session.</p>
                    <p class="text-muted small">This page will automatically update when HR starts your interview.</p>
                </div>
            </div>

            <!-- Interview Ready Container -->
            <div id="interviewReadyContainer" class="card shadow d-none">
                <div class="card-body text-center py-5">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                    <h4 class="mb-3">Interview Ready!</h4>
                    <p class="text-muted mb-4">HR has started your interview session. Click the button below to join.</p>
                    
                    <button class="btn btn-success btn-lg" onclick="joinInterview()">
                        <i class="fas fa-video me-2"></i>Join Interview
                    </button>
                </div>
            </div>

            <!-- Interview Container -->
            <div id="interviewContainer" class="card shadow d-none">
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Progress</span>
                            <span class="small" id="progressText">Question 1 of 5</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" id="progressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>

                    <!-- Question Display -->
                    <div id="questionContainer" class="mb-4">
                        <div class="alert alert-info">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Loading question...
                        </div>
                    </div>

                    <!-- Response Input Area -->
                    <div id="responseContainer" class="d-none">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Your Response</label>
                            <textarea class="form-control" id="responseText" rows="5" placeholder="Type your answer here. Take your time to provide a thoughtful response..." style="resize: vertical;"></textarea>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-lightbulb me-1"></i>
                                Tip: Use specific examples and explain your reasoning clearly.
                            </small>
                        </div>

                        <!-- Response Actions -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-outline-secondary me-2" id="skipBtn" onclick="skipQuestion()">
                                    <i class="fas fa-forward me-1"></i>Skip Question
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-primary" id="submitBtn" onclick="submitResponse()">
                                    <i class="fas fa-paper-plane me-1"></i>
                                    <span id="submitText">Submit Response</span>
                                    <span id="submitSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Feedback Display -->
                    <div id="feedbackContainer" class="d-none">
                        <div class="alert alert-success mb-3">
                            <h6 class="alert-heading">
                                <i class="fas fa-check-circle me-2"></i>Response Received
                            </h6>
                            <p id="feedbackText" class="mb-0">Your response has been recorded. AI is analyzing...</p>
                        </div>
                        <div id="aiFeedback" class="card bg-light mb-3 d-none">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-brain me-2"></i>AI Feedback
                                </h6>
                                <p id="feedbackContent" class="mb-0"></p>
                            </div>
                        </div>
                        <button class="btn btn-primary w-100" id="nextBtn" onclick="nextQuestion()">
                            <i class="fas fa-arrow-right me-1"></i>Next Question
                        </button>
                    </div>

                    <!-- Interview Complete -->
                    <div id="completeContainer" class="d-none">
                        <div class="alert alert-success mb-4">
                            <h5 class="alert-heading">
                                <i class="fas fa-check-circle me-2"></i>Interview Complete!
                            </h5>
                            <p>Thank you for completing the interview. Your responses have been recorded and will be reviewed by our HR team.</p>
                        </div>

                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h6 class="card-title mb-3">Interview Summary</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <small class="text-muted d-block">Questions Answered</small>
                                        <strong id="answeredCount">0</strong>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <small class="text-muted d-block">Questions Skipped</small>
                                        <strong id="skippedCount">0</strong>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <small class="text-muted d-block">Total Duration</small>
                                        <strong id="totalDuration">00:00</strong>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <small class="text-muted d-block">Performance Score</small>
                                        <strong id="performanceScore">--</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-primary" id="downloadReportBtn" onclick="downloadReport()">
                                <i class="fas fa-download me-1"></i>Download Report
                            </button>
                            <button class="btn btn-primary" id="exitCompleteBtn" onclick="exitInterview()">
                                <i class="fas fa-home me-1"></i>Return to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tips Card -->
            <div class="card shadow mt-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Interview Tips</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong class="small d-block mb-1">✓ Do's</strong>
                            <ul class="small mb-0 ps-3">
                                <li>Be honest and authentic</li>
                                <li>Provide specific examples</li>
                                <li>Show enthusiasm</li>
                                <li>Ask clarifying questions</li>
                            </ul>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong class="small d-block mb-1">✗ Don'ts</strong>
                            <ul class="small mb-0 ps-3">
                                <li>Rush your answers</li>
                                <li>Give vague responses</li>
                                <li>Interrupt the AI</li>
                                <li>Leave long pauses</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exit Confirmation Modal -->
<div class="modal fade" id="exitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Exit Interview?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to exit the interview? Your responses so far will be saved.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Interview</button>
                <button type="button" class="btn btn-danger" onclick="exitInterview()">Exit Interview</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables for AI interview system
let currentQuestion = '';
let currentAnswer = '';
let currentQuestionIndex = 0;
let totalQuestions = 5;
let responses = [];
let skippedQuestions = [];
let startTime = null;
let interviewSummary = null;
let interviewStatus = 'waiting'; // waiting, ready, in_progress, completed

// DOM Elements
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const questionContainer = document.getElementById('questionContainer');
const responseContainer = document.getElementById('responseContainer');
const responseText = document.getElementById('responseText');
const submitBtn = document.getElementById('submitBtn');
const submitText = document.getElementById('submitText');
const submitSpinner = document.getElementById('submitSpinner');
const feedbackContainer = document.getElementById('feedbackContainer');
const feedbackText = document.getElementById('feedbackText');
const aiFeedback = document.getElementById('aiFeedback');
const feedbackContent = document.getElementById('feedbackContent');
const nextBtn = document.getElementById('nextBtn');
const completeContainer = document.getElementById('completeContainer');
const answeredCount = document.getElementById('answeredCount');
const skippedCount = document.getElementById('skippedCount');
const totalDuration = document.getElementById('totalDuration');
const performanceScore = document.getElementById('performanceScore');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadInterviewData();
    checkInterviewStatus();
    setInterval(checkInterviewStatus, 3000); // Check every 3 seconds
});

// Load interview data
function loadInterviewData() {
    const urlParams = new URLSearchParams(window.location.search);
    const interviewData = {
        position: urlParams.get('position') || 'Software Engineer',
        type: urlParams.get('type') || 'Technical',
        difficulty: urlParams.get('difficulty') || 'Mid-level',
        duration: urlParams.get('duration') || '30',
        instructions: urlParams.get('instructions') || 'Please answer all questions to the best of your ability.'
    };

    document.getElementById('positionName').textContent = interviewData.position;
    document.getElementById('interviewType').textContent = interviewData.type;
    document.getElementById('difficultyLevel').textContent = interviewData.difficulty;
    document.getElementById('duration').textContent = interviewData.duration + ' minutes';
    document.getElementById('hrInstructions').innerHTML = `<p>${interviewData.instructions}</p>`;
}

// Send ready message to HR
function sendReadyMessage() {
    const message = document.getElementById('readyMessage').value || 'I am ready for the interview';
    
    fetch('/api/notifications/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            recipients: [], // Will be sent to all HR users
            subject: 'Employee Ready for Interview',
            content: message,
            message_type: 'interview_ready',
            priority: 'high'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('waitingContainer').classList.add('d-none');
            document.getElementById('waitingForHRContainer').classList.remove('d-none');
            interviewStatus = 'waiting_for_hr';
        }
    })
    .catch(error => console.error('Error:', error));
}

// Check interview status
function checkInterviewStatus() {
    fetch('/api/employee/interview/status')
        .then(response => response.json())
        .then(data => {
            if (data.interview_status === 'ready') {
                interviewStatus = 'ready';
                document.getElementById('waitingForHRContainer').classList.add('d-none');
                document.getElementById('interviewReadyContainer').classList.remove('d-none');
            } else if (data.interview_status === 'requested') {
                // Still waiting for HR
                interviewStatus = 'waiting_for_hr';
            }
        })
        .catch(error => console.error('Error:', error));
}

// Join interview
async function joinInterview() {
    interviewStatus = 'in_progress';
    startTime = new Date();
    
    // Hide ready container, show interview container
    document.getElementById('interviewReadyContainer').classList.add('d-none');
    document.getElementById('interviewContainer').classList.remove('d-none');
    document.getElementById('exitBtn').style.display = 'inline-block';
    document.getElementById('timerBadge').style.display = 'inline-block';
    
    // Start timer
    startTimer();
    
    try {
        // Start AI interview session
        const response = await fetch('/api/interview/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                interview_type: getInterviewType(),
                is_fresher: getIsFresher(),
                job_role: getJobRole(),
                enable_hr_training: true
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to start interview');
        }
        
        const data = await response.json();
        totalQuestions = data.total_questions || 5;
        
        // Get first question
        await getNextQuestion();
        
    } catch (error) {
        console.error('Error starting interview:', error);
        showError('Failed to start interview. Please try again.');
    }
}

// Get next question
async function getNextQuestion() {
    try {
        updateProgress();
        
        // Show loading state
        questionContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Loading question...
            </div>
        `;
        responseContainer.classList.add('d-none');
        feedbackContainer.classList.add('d-none');
        
        // Get question from backend
        const response = await fetch('/api/interview/next-question', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question_index: currentQuestionIndex,
                previous_question: currentQuestion,
                previous_answer: currentAnswer
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to get question');
        }
        
        const data = await response.json();
        currentQuestion = data.question;
        currentQuestionIndex = data.question_index;
        
        // Display question
        questionContainer.innerHTML = `
            <div class="alert alert-primary">
                <h6 class="alert-heading mb-3">
                    <i class="fas fa-question-circle me-2"></i>Question ${currentQuestionIndex}
                </h6>
                <p class="mb-0 fs-5">${currentQuestion}</p>
            </div>
        `;
        
        responseContainer.classList.remove('d-none');
        responseText.value = '';
        responseText.focus();
        
    } catch (error) {
        console.error('Error getting question:', error);
        showError('Failed to get question. Please try again.');
    }
}

// Submit response
async function submitResponse() {
    currentAnswer = responseText.value.trim();
    if (!currentAnswer) {
        responseText.classList.add('is-invalid');
        return;
    }
    
    responseText.classList.remove('is-invalid');
    
    // Disable submit button and show loading
    submitBtn.disabled = true;
    submitText.textContent = 'Submitting...';
    submitSpinner.classList.remove('d-none');
    
    try {
        // Send response to backend for analysis
        const response = await fetch('/api/interview/analyze-response', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question: currentQuestion,
                answer: currentAnswer,
                question_index: currentQuestionIndex - 1
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to analyze response');
        }
        
        const data = await response.json();
        
        // Store response
        responses.push({
            question: currentQuestion,
            answer: currentAnswer,
            feedback: data.feedback,
            question_index: currentQuestionIndex - 1
        });
        
        // Show feedback
        showFeedback(data.feedback);
        
    } catch (error) {
        console.error('Error submitting response:', error);
        showError('Failed to submit response. Please try again.');
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitText.textContent = 'Submit Response';
        submitSpinner.classList.add('d-none');
    }
}

// Show feedback
function showFeedback(feedback) {
    feedbackText.textContent = 'Your response has been recorded and analyzed.';
    
    // Show AI feedback
    aiFeedback.classList.remove('d-none');
    feedbackContent.innerHTML = `
        <div class="mb-3">
            <strong>Analysis:</strong>
            <p class="mb-2">${feedback.analysis}</p>
        </div>
        <div class="row">
            <div class="col-md-6">
                <strong>Score:</strong>
                <div class="progress mt-1" style="height: 20px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: ${feedback.score * 10}%" 
                         aria-valuenow="${feedback.score}" 
                         aria-valuemin="0" 
                         aria-valuemax="10">
                        ${feedback.score}/10
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <strong>Keywords:</strong>
                <div class="mt-1">
                    ${feedback.keywords.map(kw => `<span class="badge bg-info me-1">${kw}</span>`).join('')}
                </div>
            </div>
        </div>
    `;
    
    // Show feedback container, hide response container
    responseContainer.classList.add('d-none');
    feedbackContainer.classList.remove('d-none');
}

// Next question
async function nextQuestion() {
    if (currentQuestionIndex >= totalQuestions) {
        await completeInterview();
        return;
    }
    
    await getNextQuestion();
}

// Skip question
async function skipQuestion() {
    if (confirm('Are you sure you want to skip this question?')) {
        skippedQuestions.push({
            question: currentQuestion,
            question_index: currentQuestionIndex - 1
        });
        
        currentAnswer = '(Question skipped)';
        await nextQuestion();
    }
}

// Complete interview
async function completeInterview() {
    try {
        // Get interview summary
        const response = await fetch('/api/interview/summary', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to get interview summary');
        }
        
        interviewSummary = await response.json();
        
        // Update completion UI
        updateCompletionUI();
        
        // Hide interview container, show complete container
        document.getElementById('interviewContainer').classList.add('d-none');
        completeContainer.classList.remove('d-none');
        
        // Stop timer
        stopTimer();
        
        interviewStatus = 'completed';
        
    } catch (error) {
        console.error('Error completing interview:', error);
        showError('Failed to complete interview. Please try again.');
    }
}

// Update completion UI
function updateCompletionUI() {
    answeredCount.textContent = responses.length;
    skippedCount.textContent = skippedQuestions.length;
    performanceScore.textContent = interviewSummary.overall_score.toFixed(1) + '/10';
    
    // Add performance color coding
    const score = interviewSummary.overall_score;
    if (score >= 8) {
        performanceScore.className = 'text-success';
    } else if (score >= 6) {
        performanceScore.className = 'text-warning';
    } else {
        performanceScore.className = 'text-danger';
    }
}

// Update progress
function updateProgress() {
    const progress = (currentQuestionIndex / totalQuestions) * 100;
    progressBar.style.width = `${progress}%`;
    progressBar.setAttribute('aria-valuenow', progress);
    progressText.textContent = `Question ${currentQuestionIndex} of ${totalQuestions}`;
}

// Timer functions
let timerInterval;
function startTimer() {
    timerInterval = setInterval(updateTimer, 1000);
}

function stopTimer() {
    clearInterval(timerInterval);
}

function updateTimer() {
    if (!startTime) return;
    
    const now = new Date();
    const elapsed = Math.floor((now - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('timerBadge').textContent = timeString;
    
    if (interviewStatus === 'completed') {
        totalDuration.textContent = timeString;
    }
}

// Helper functions
function getInterviewType() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('type') || 'technical';
}

function getIsFresher() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('level') === 'fresher';
}

function getJobRole() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('position') || 'Software Engineer';
}

// Error handling
function showError(message) {
    questionContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// Exit interview
function confirmExit() {
    if (confirm('Are you sure you want to exit the interview? Your progress will be saved.')) {
        exitInterview();
    }
}

function exitInterview() {
    stopTimer();
    window.location.href = '/employee/dashboard';
}

// Download report
function downloadReport() {
    if (!interviewSummary) {
        alert('No interview data available to download.');
        return;
    }
    
    // Create a downloadable report
    const report = {
        position: getJobRole(),
        interview_type: getInterviewType(),
        date: new Date().toISOString(),
        duration: document.getElementById('totalDuration').textContent,
        questions_answered: responses.length,
        questions_skipped: skippedQuestions.length,
        performance_score: interviewSummary.overall_score,
        recommendation: interviewSummary.recommendation,
        strengths: interviewSummary.strengths,
        areas_for_improvement: interviewSummary.areas_for_improvement,
        responses: responses.map(r => ({
            question: r.question,
            answer: r.answer,
            score: r.feedback.score
        }))
    };
    
    // Create a blob and download link
    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `interview-report-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
